This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-06-30 12:06:44

# File Summary

## Purpose:

This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format:

The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
   a. A header with the file path (## File: path/to/file)
   b. The full contents of the file in a code block

## Usage Guidelines:

- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes:

- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

## Additional Information:

For more information about Repomix, visit: https://github.com/andersonby/python-repomix


# Repository Structure

```
bin
  dev_code_v1.1.ipynb
code_1.2.0.ipynb
src
  add_fields.py
  core_transform.py
  distribution.py
  main.py
  output_to_excel.py
  output_to_excel_multiple_sheets.py
  transformations
    calculations.py
    joining.py
    __init__.py
  _version.py
  __init__.py
```

# Repository Files


## bin/dev_code_v1.1.ipynb

```text
{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "import cdutils.filtering"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "\"\"\"\n",
    "Main Entry Point\n",
    "\"\"\"\n",
    "from pathlib import Path\n",
    "\n",
    "import pandas as pd # type: ignore\n",
    "\n",
    "import cdutils.pkey_sqlite # type: ignore\n",
    "import src.core_transform\n",
    "import src.output_to_excel\n",
    "from src._version import __version__\n",
    "\n",
    "# def main(production_flag: bool=False):\n",
    "    # if production_flag:\n",
    "        # BASE_PATH = Path(r'\\\\00-DA1\\Home\\Share\\Line of Business_Shared Services')\n",
    "        # assert \"prod\" in __version__, (f\"Cannot run in production mode without 'prod' in the __version__\")\n",
    "    # else:\n",
    "        # BASE_PATH = Path('.')\n",
    "\n",
    "# Get staging data from the daily deposit update. View dev section of documentation for more detail\n",
    "INPUT_PATH = Path(r\"\\\\00-da1\\Home\\Share\\Data & Analytics Initiatives\\Project Management\\Data_Analytics\\Daily_Deposit_Update\\Production\\output\\DailyDeposit_staging.xlsx\")\n",
    "data = pd.read_excel(INPUT_PATH)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>acctnbr</th>\n",
       "      <th>effdate</th>\n",
       "      <th>mjaccttypcd</th>\n",
       "      <th>product</th>\n",
       "      <th>notebal</th>\n",
       "      <th>notemtdavgbal</th>\n",
       "      <th>currmiaccttypcd</th>\n",
       "      <th>acctofficer</th>\n",
       "      <th>ownersortname</th>\n",
       "      <th>curracctstatcd</th>\n",
       "      <th>...</th>\n",
       "      <th>ytdavgbal</th>\n",
       "      <th>3Mo_AvgBal</th>\n",
       "      <th>TTM_AvgBal</th>\n",
       "      <th>Year Ago Balance</th>\n",
       "      <th>TTM_DAYS_OVERDRAWN</th>\n",
       "      <th>TTM_NSF_COUNT</th>\n",
       "      <th>YTD_DAYS_OVERDRAWN</th>\n",
       "      <th>YTD_NSF_COUNT</th>\n",
       "      <th>householdnbr</th>\n",
       "      <th>datelastmaint</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>102488</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>Simple Business Checking</td>\n",
       "      <td>11452.51</td>\n",
       "      <td>11452.51</td>\n",
       "      <td>CK25</td>\n",
       "      <td>TIFFANY J. CAHILL</td>\n",
       "      <td>PICKLES PLUMBING &amp; HEATING LLC</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>6960.96</td>\n",
       "      <td>6820.500000</td>\n",
       "      <td>10205.697500</td>\n",
       "      <td>3429.11</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>230804.0</td>\n",
       "      <td>2021-09-23 22:51:42</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>102491</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>Business Elite Money Market</td>\n",
       "      <td>50810.21</td>\n",
       "      <td>50810.21</td>\n",
       "      <td>CK30</td>\n",
       "      <td>LAURA A. STACK</td>\n",
       "      <td>THE PAWS GROUP LLC</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>50733.14</td>\n",
       "      <td>50730.136667</td>\n",
       "      <td>329678.648333</td>\n",
       "      <td>430708.34</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>229764.0</td>\n",
       "      <td>2023-10-30 13:17:29</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>103067</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>Business Elite Money Market</td>\n",
       "      <td>10696.53</td>\n",
       "      <td>10696.53</td>\n",
       "      <td>CK30</td>\n",
       "      <td>JUSTIN A. JEFFREY</td>\n",
       "      <td>BLACKSTONE VALLEY PEDIATRIC &amp;</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>10680.31</td>\n",
       "      <td>10679.673333</td>\n",
       "      <td>10640.750833</td>\n",
       "      <td>10583.91</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaT</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>103072</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>Simple Business Checking</td>\n",
       "      <td>4965.63</td>\n",
       "      <td>4965.63</td>\n",
       "      <td>CK25</td>\n",
       "      <td>TIFFANY J. CAHILL</td>\n",
       "      <td>GREENVILLE COMMON PROPERTIES</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>959.25</td>\n",
       "      <td>856.356667</td>\n",
       "      <td>897.033333</td>\n",
       "      <td>752.74</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>182482.0</td>\n",
       "      <td>2021-12-02 17:32:20</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>103078</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>NOW Checking</td>\n",
       "      <td>125811.37</td>\n",
       "      <td>125811.37</td>\n",
       "      <td>CK05</td>\n",
       "      <td>JUSTIN A. JEFFREY</td>\n",
       "      <td>NARDO, MARTINO</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>101559.07</td>\n",
       "      <td>100526.300000</td>\n",
       "      <td>134840.330000</td>\n",
       "      <td>74484.18</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>203764.0</td>\n",
       "      <td>2020-09-29 00:31:31</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62770</th>\n",
       "      <td>151146117</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>TD</td>\n",
       "      <td>6 Month Prime Time CD</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>CD25</td>\n",
       "      <td>MICHAEL A. HEY</td>\n",
       "      <td>COLEMAN, ELAINE M.</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>5978.26</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>111269.0</td>\n",
       "      <td>2025-02-07 20:29:33</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62771</th>\n",
       "      <td>151146125</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>SAV</td>\n",
       "      <td>Prime Time MM Passbook</td>\n",
       "      <td>850.07</td>\n",
       "      <td>850.07</td>\n",
       "      <td>SV01</td>\n",
       "      <td>MARLENE C. LIRA</td>\n",
       "      <td>MEDEIROS, VALDEMIRO D.</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>508.16</td>\n",
       "      <td>758.945000</td>\n",
       "      <td>758.945000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>147615.0</td>\n",
       "      <td>2025-02-07 20:29:33</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62772</th>\n",
       "      <td>151146133</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>TD</td>\n",
       "      <td>6 Month Prime Time CD</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>CD25</td>\n",
       "      <td>MICHAEL A. HEY</td>\n",
       "      <td>COLEMAN, ELAINE M.</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>5978.26</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>111269.0</td>\n",
       "      <td>2025-02-07 20:29:33</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62773</th>\n",
       "      <td>151146141</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>TD</td>\n",
       "      <td>6 Month Prime Time CD</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>CD25</td>\n",
       "      <td>MICHAEL A. HEY</td>\n",
       "      <td>COLEMAN, ELAINE M.</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>5978.26</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>111269.0</td>\n",
       "      <td>2025-02-07 20:29:33</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62774</th>\n",
       "      <td>151146159</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>eChecking (18 &amp; over)</td>\n",
       "      <td>-4.66</td>\n",
       "      <td>-4.66</td>\n",
       "      <td>CK04</td>\n",
       "      <td>JACQUELINE A. THEIS</td>\n",
       "      <td>SOUZA, ALFRED D. III</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>65.51</td>\n",
       "      <td>99.325000</td>\n",
       "      <td>99.325000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>18</td>\n",
       "      <td>2</td>\n",
       "      <td>18</td>\n",
       "      <td>2</td>\n",
       "      <td>306312.0</td>\n",
       "      <td>2025-02-07 20:29:34</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>62775 rows × 21 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "         acctnbr    effdate mjaccttypcd                      product  \\\n",
       "0         102488 2025-04-02          CK     Simple Business Checking   \n",
       "1         102491 2025-04-02          CK  Business Elite Money Market   \n",
       "2         103067 2025-04-02          CK  Business Elite Money Market   \n",
       "3         103072 2025-04-02          CK     Simple Business Checking   \n",
       "4         103078 2025-04-02          CK                 NOW Checking   \n",
       "...          ...        ...         ...                          ...   \n",
       "62770  151146117 2025-04-02          TD        6 Month Prime Time CD   \n",
       "62771  151146125 2025-04-02         SAV       Prime Time MM Passbook   \n",
       "62772  151146133 2025-04-02          TD        6 Month Prime Time CD   \n",
       "62773  151146141 2025-04-02          TD        6 Month Prime Time CD   \n",
       "62774  151146159 2025-04-02          CK        eChecking (18 & over)   \n",
       "\n",
       "         notebal  notemtdavgbal currmiaccttypcd          acctofficer  \\\n",
       "0       11452.51       11452.51            CK25    TIFFANY J. CAHILL   \n",
       "1       50810.21       50810.21            CK30       LAURA A. STACK   \n",
       "2       10696.53       10696.53            CK30    JUSTIN A. JEFFREY   \n",
       "3        4965.63        4965.63            CK25    TIFFANY J. CAHILL   \n",
       "4      125811.37      125811.37            CK05    JUSTIN A. JEFFREY   \n",
       "...          ...            ...             ...                  ...   \n",
       "62770   10000.00       10000.00            CD25       MICHAEL A. HEY   \n",
       "62771     850.07         850.07            SV01      MARLENE C. LIRA   \n",
       "62772   10000.00       10000.00            CD25       MICHAEL A. HEY   \n",
       "62773   10000.00       10000.00            CD25       MICHAEL A. HEY   \n",
       "62774      -4.66          -4.66            CK04  JACQUELINE A. THEIS   \n",
       "\n",
       "                        ownersortname curracctstatcd  ...  ytdavgbal  \\\n",
       "0      PICKLES PLUMBING & HEATING LLC            ACT  ...    6960.96   \n",
       "1                  THE PAWS GROUP LLC            ACT  ...   50733.14   \n",
       "2       BLACKSTONE VALLEY PEDIATRIC &            ACT  ...   10680.31   \n",
       "3        GREENVILLE COMMON PROPERTIES            ACT  ...     959.25   \n",
       "4                      NARDO, MARTINO            ACT  ...  101559.07   \n",
       "...                               ...            ...  ...        ...   \n",
       "62770              COLEMAN, ELAINE M.            ACT  ...    5978.26   \n",
       "62771          MEDEIROS, VALDEMIRO D.            ACT  ...     508.16   \n",
       "62772              COLEMAN, ELAINE M.            ACT  ...    5978.26   \n",
       "62773              COLEMAN, ELAINE M.            ACT  ...    5978.26   \n",
       "62774            SOUZA, ALFRED D. III            ACT  ...      65.51   \n",
       "\n",
       "          3Mo_AvgBal     TTM_AvgBal  Year Ago Balance  TTM_DAYS_OVERDRAWN  \\\n",
       "0        6820.500000   10205.697500           3429.11                   0   \n",
       "1       50730.136667  329678.648333         430708.34                   0   \n",
       "2       10679.673333   10640.750833          10583.91                   0   \n",
       "3         856.356667     897.033333            752.74                   0   \n",
       "4      100526.300000  134840.330000          74484.18                   0   \n",
       "...              ...            ...               ...                 ...   \n",
       "62770    8928.570000    8928.570000              0.00                   0   \n",
       "62771     758.945000     758.945000              0.00                   0   \n",
       "62772    8928.570000    8928.570000              0.00                   0   \n",
       "62773    8928.570000    8928.570000              0.00                   0   \n",
       "62774      99.325000      99.325000              0.00                  18   \n",
       "\n",
       "       TTM_NSF_COUNT  YTD_DAYS_OVERDRAWN  YTD_NSF_COUNT  householdnbr  \\\n",
       "0                  0                   0              0      230804.0   \n",
       "1                  0                   0              0      229764.0   \n",
       "2                  0                   0              0           NaN   \n",
       "3                  0                   0              0      182482.0   \n",
       "4                  0                   0              0      203764.0   \n",
       "...              ...                 ...            ...           ...   \n",
       "62770              0                   0              0      111269.0   \n",
       "62771              0                   0              0      147615.0   \n",
       "62772              0                   0              0      111269.0   \n",
       "62773              0                   0              0      111269.0   \n",
       "62774              2                  18              2      306312.0   \n",
       "\n",
       "            datelastmaint  \n",
       "0     2021-09-23 22:51:42  \n",
       "1     2023-10-30 13:17:29  \n",
       "2                     NaT  \n",
       "3     2021-12-02 17:32:20  \n",
       "4     2020-09-29 00:31:31  \n",
       "...                   ...  \n",
       "62770 2025-02-07 20:29:33  \n",
       "62771 2025-02-07 20:29:33  \n",
       "62772 2025-02-07 20:29:33  \n",
       "62773 2025-02-07 20:29:33  \n",
       "62774 2025-02-07 20:29:34  \n",
       "\n",
       "[62775 rows x 21 columns]"
      ]
     },
     "execution_count": 2,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>acctnbr</th>\n",
       "      <th>effdate</th>\n",
       "      <th>mjaccttypcd</th>\n",
       "      <th>product</th>\n",
       "      <th>notebal</th>\n",
       "      <th>notemtdavgbal</th>\n",
       "      <th>currmiaccttypcd</th>\n",
       "      <th>acctofficer</th>\n",
       "      <th>ownersortname</th>\n",
       "      <th>curracctstatcd</th>\n",
       "      <th>...</th>\n",
       "      <th>ytdavgbal</th>\n",
       "      <th>3Mo_AvgBal</th>\n",
       "      <th>TTM_AvgBal</th>\n",
       "      <th>Year Ago Balance</th>\n",
       "      <th>TTM_DAYS_OVERDRAWN</th>\n",
       "      <th>TTM_NSF_COUNT</th>\n",
       "      <th>YTD_DAYS_OVERDRAWN</th>\n",
       "      <th>YTD_NSF_COUNT</th>\n",
       "      <th>householdnbr</th>\n",
       "      <th>datelastmaint</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>102488</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>Simple Business Checking</td>\n",
       "      <td>11452.51</td>\n",
       "      <td>11452.51</td>\n",
       "      <td>CK25</td>\n",
       "      <td>TIFFANY J. CAHILL</td>\n",
       "      <td>PICKLES PLUMBING &amp; HEATING LLC</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>6960.96</td>\n",
       "      <td>6820.5</td>\n",
       "      <td>10205.6975</td>\n",
       "      <td>3429.11</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>230804.0</td>\n",
       "      <td>2021-09-23 22:51:42</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>1 rows × 21 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "   acctnbr    effdate mjaccttypcd                   product   notebal  \\\n",
       "0   102488 2025-04-02          CK  Simple Business Checking  11452.51   \n",
       "\n",
       "   notemtdavgbal currmiaccttypcd        acctofficer  \\\n",
       "0       11452.51            CK25  TIFFANY J. CAHILL   \n",
       "\n",
       "                    ownersortname curracctstatcd  ... ytdavgbal  3Mo_AvgBal  \\\n",
       "0  PICKLES PLUMBING & HEATING LLC            ACT  ...   6960.96      6820.5   \n",
       "\n",
       "   TTM_AvgBal  Year Ago Balance  TTM_DAYS_OVERDRAWN  TTM_NSF_COUNT  \\\n",
       "0  10205.6975           3429.11                   0              0   \n",
       "\n",
       "   YTD_DAYS_OVERDRAWN  YTD_NSF_COUNT  householdnbr       datelastmaint  \n",
       "0                   0              0      230804.0 2021-09-23 22:51:42  \n",
       "\n",
       "[1 rows x 21 columns]"
      ]
     },
     "execution_count": 3,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "data[data['acctnbr'] == 102488]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "ename": "KeyError",
     "evalue": "\"['portfolio_key'] not in index\"",
     "output_type": "error",
     "traceback": [
      "\u001b[31m---------------------------------------------------------------------------\u001b[39m",
      "\u001b[31mKeyError\u001b[39m                                  Traceback (most recent call last)",
      "\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[4]\u001b[39m\u001b[32m, line 1\u001b[39m\n\u001b[32m----> \u001b[39m\u001b[32m1\u001b[39m raw_data = \u001b[43msrc\u001b[49m\u001b[43m.\u001b[49m\u001b[43mcore_transform\u001b[49m\u001b[43m.\u001b[49m\u001b[43mmain_pipeline\u001b[49m\u001b[43m(\u001b[49m\u001b[43mdata\u001b[49m\u001b[43m)\u001b[49m\n",
      "\u001b[36mFile \u001b[39m\u001b[32mz:\\Data_Analytics\\Concentration_of_Deposits\\Development\\src\\core_transform.py:71\u001b[39m, in \u001b[36mmain_pipeline\u001b[39m\u001b[34m(data)\u001b[39m\n\u001b[32m     63\u001b[39m \u001b[38;5;250m\u001b[39m\u001b[33;03m\"\"\"\u001b[39;00m\n\u001b[32m     64\u001b[39m \u001b[33;03mMain data pipeline \u001b[39;00m\n\u001b[32m     65\u001b[39m \u001b[33;03m\"\"\"\u001b[39;00m\n\u001b[32m     66\u001b[39m \u001b[38;5;66;03m# # Set column types\u001b[39;00m\n\u001b[32m     67\u001b[39m \u001b[38;5;66;03m# numeric_cols = ['noteintrate','bookbalance','notebal']\u001b[39;00m\n\u001b[32m     68\u001b[39m \u001b[38;5;66;03m# for col in numeric_cols:\u001b[39;00m\n\u001b[32m     69\u001b[39m \u001b[38;5;66;03m#     df[col] = pd.to_numeric(df[col])\u001b[39;00m\n\u001b[32m---> \u001b[39m\u001b[32m71\u001b[39m data = \u001b[43mdata\u001b[49m\u001b[43m[\u001b[49m\u001b[43m[\u001b[49m\n\u001b[32m     72\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mportfolio_key\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     73\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43macctnbr\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     74\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mownersortname\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     75\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mproduct\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     76\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mmjaccttypcd\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     77\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mcurrmiaccttypcd\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     78\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43macctofficer\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     79\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mnotebal\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     80\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mcurracctstatcd\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     81\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mcontractdate\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     82\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mytdavgbal\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     83\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43m3Mo_AvgBal\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     84\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mTTM_AvgBal\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     85\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mYear Ago Balance\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     86\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mTTM_DAYS_OVERDRAWN\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     87\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mTTM_NSF_COUNT\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     88\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mYTD_DAYS_OVERDRAWN\u001b[39;49m\u001b[33;43m'\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m     89\u001b[39m \u001b[43m    \u001b[49m\u001b[33;43m'\u001b[39;49m\u001b[33;43mYTD_NSF_COUNT\u001b[39;49m\u001b[33;43m'\u001b[39;49m\n\u001b[32m     90\u001b[39m \u001b[43m\u001b[49m\u001b[43m]\u001b[49m\u001b[43m]\u001b[49m.copy()\n\u001b[32m     92\u001b[39m df = group_and_summarize(data, \u001b[33m\"\u001b[39m\u001b[33mportfolio_key\u001b[39m\u001b[33m\"\u001b[39m, \u001b[33m\"\u001b[39m\u001b[33mnotebal\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m     94\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m df\n",
      "\u001b[36mFile \u001b[39m\u001b[32mc:\\Users\\w322800\\Documents\\coding3\\.venv\\Lib\\site-packages\\pandas\\core\\frame.py:4108\u001b[39m, in \u001b[36mDataFrame.__getitem__\u001b[39m\u001b[34m(self, key)\u001b[39m\n\u001b[32m   4106\u001b[39m     \u001b[38;5;28;01mif\u001b[39;00m is_iterator(key):\n\u001b[32m   4107\u001b[39m         key = \u001b[38;5;28mlist\u001b[39m(key)\n\u001b[32m-> \u001b[39m\u001b[32m4108\u001b[39m     indexer = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mcolumns\u001b[49m\u001b[43m.\u001b[49m\u001b[43m_get_indexer_strict\u001b[49m\u001b[43m(\u001b[49m\u001b[43mkey\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mcolumns\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m)\u001b[49m[\u001b[32m1\u001b[39m]\n\u001b[32m   4110\u001b[39m \u001b[38;5;66;03m# take() does not accept boolean indexers\u001b[39;00m\n\u001b[32m   4111\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mgetattr\u001b[39m(indexer, \u001b[33m\"\u001b[39m\u001b[33mdtype\u001b[39m\u001b[33m\"\u001b[39m, \u001b[38;5;28;01mNone\u001b[39;00m) == \u001b[38;5;28mbool\u001b[39m:\n",
      "\u001b[36mFile \u001b[39m\u001b[32mc:\\Users\\w322800\\Documents\\coding3\\.venv\\Lib\\site-packages\\pandas\\core\\indexes\\base.py:6200\u001b[39m, in \u001b[36mIndex._get_indexer_strict\u001b[39m\u001b[34m(self, key, axis_name)\u001b[39m\n\u001b[32m   6197\u001b[39m \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[32m   6198\u001b[39m     keyarr, indexer, new_indexer = \u001b[38;5;28mself\u001b[39m._reindex_non_unique(keyarr)\n\u001b[32m-> \u001b[39m\u001b[32m6200\u001b[39m \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_raise_if_missing\u001b[49m\u001b[43m(\u001b[49m\u001b[43mkeyarr\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mindexer\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43maxis_name\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m   6202\u001b[39m keyarr = \u001b[38;5;28mself\u001b[39m.take(indexer)\n\u001b[32m   6203\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28misinstance\u001b[39m(key, Index):\n\u001b[32m   6204\u001b[39m     \u001b[38;5;66;03m# GH 42790 - Preserve name from an Index\u001b[39;00m\n",
      "\u001b[36mFile \u001b[39m\u001b[32mc:\\Users\\w322800\\Documents\\coding3\\.venv\\Lib\\site-packages\\pandas\\core\\indexes\\base.py:6252\u001b[39m, in \u001b[36mIndex._raise_if_missing\u001b[39m\u001b[34m(self, key, indexer, axis_name)\u001b[39m\n\u001b[32m   6249\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mKeyError\u001b[39;00m(\u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33mNone of [\u001b[39m\u001b[38;5;132;01m{\u001b[39;00mkey\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m] are in the [\u001b[39m\u001b[38;5;132;01m{\u001b[39;00maxis_name\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m]\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m   6251\u001b[39m not_found = \u001b[38;5;28mlist\u001b[39m(ensure_index(key)[missing_mask.nonzero()[\u001b[32m0\u001b[39m]].unique())\n\u001b[32m-> \u001b[39m\u001b[32m6252\u001b[39m \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mKeyError\u001b[39;00m(\u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[38;5;132;01m{\u001b[39;00mnot_found\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m not in index\u001b[39m\u001b[33m\"\u001b[39m)\n",
      "\u001b[31mKeyError\u001b[39m: \"['portfolio_key'] not in index\""
     ]
    }
   ],
   "source": [
    "raw_data = src.core_transform.main_pipeline(data)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [],
   "source": [
    "df = cdutils.pkey_sqlite.add_pkey(data)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>acctnbr</th>\n",
       "      <th>effdate</th>\n",
       "      <th>mjaccttypcd</th>\n",
       "      <th>product</th>\n",
       "      <th>notebal</th>\n",
       "      <th>notemtdavgbal</th>\n",
       "      <th>currmiaccttypcd</th>\n",
       "      <th>acctofficer</th>\n",
       "      <th>ownersortname</th>\n",
       "      <th>curracctstatcd</th>\n",
       "      <th>...</th>\n",
       "      <th>3Mo_AvgBal</th>\n",
       "      <th>TTM_AvgBal</th>\n",
       "      <th>Year Ago Balance</th>\n",
       "      <th>TTM_DAYS_OVERDRAWN</th>\n",
       "      <th>TTM_NSF_COUNT</th>\n",
       "      <th>YTD_DAYS_OVERDRAWN</th>\n",
       "      <th>YTD_NSF_COUNT</th>\n",
       "      <th>householdnbr</th>\n",
       "      <th>datelastmaint</th>\n",
       "      <th>portfolio_key</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>0 rows × 22 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "Empty DataFrame\n",
       "Columns: [acctnbr, effdate, mjaccttypcd, product, notebal, notemtdavgbal, currmiaccttypcd, acctofficer, ownersortname, curracctstatcd, contractdate, ytdavgbal, 3Mo_AvgBal, TTM_AvgBal, Year Ago Balance, TTM_DAYS_OVERDRAWN, TTM_NSF_COUNT, YTD_DAYS_OVERDRAWN, YTD_NSF_COUNT, householdnbr, datelastmaint, portfolio_key]\n",
       "Index: []\n",
       "\n",
       "[0 rows x 22 columns]"
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df[df['acctnbr'] == 102488]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>acctnbr</th>\n",
       "      <th>effdate</th>\n",
       "      <th>mjaccttypcd</th>\n",
       "      <th>product</th>\n",
       "      <th>notebal</th>\n",
       "      <th>notemtdavgbal</th>\n",
       "      <th>currmiaccttypcd</th>\n",
       "      <th>acctofficer</th>\n",
       "      <th>ownersortname</th>\n",
       "      <th>curracctstatcd</th>\n",
       "      <th>...</th>\n",
       "      <th>3Mo_AvgBal</th>\n",
       "      <th>TTM_AvgBal</th>\n",
       "      <th>Year Ago Balance</th>\n",
       "      <th>TTM_DAYS_OVERDRAWN</th>\n",
       "      <th>TTM_NSF_COUNT</th>\n",
       "      <th>YTD_DAYS_OVERDRAWN</th>\n",
       "      <th>YTD_NSF_COUNT</th>\n",
       "      <th>householdnbr</th>\n",
       "      <th>datelastmaint</th>\n",
       "      <th>portfolio_key</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>442</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>Simple Business Checking</td>\n",
       "      <td>11452.51</td>\n",
       "      <td>11452.51</td>\n",
       "      <td>CK25</td>\n",
       "      <td>TIFFANY J. CAHILL</td>\n",
       "      <td>PICKLES PLUMBING &amp; HEATING LLC</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>6820.500000</td>\n",
       "      <td>10205.697500</td>\n",
       "      <td>3429.11</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>230804.0</td>\n",
       "      <td>2021-09-23 22:51:42</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>444</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>Business Elite Money Market</td>\n",
       "      <td>50810.21</td>\n",
       "      <td>50810.21</td>\n",
       "      <td>CK30</td>\n",
       "      <td>LAURA A. STACK</td>\n",
       "      <td>THE PAWS GROUP LLC</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>50730.136667</td>\n",
       "      <td>329678.648333</td>\n",
       "      <td>430708.34</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>229764.0</td>\n",
       "      <td>2023-10-30 13:17:29</td>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>445</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>Business Elite Money Market</td>\n",
       "      <td>10696.53</td>\n",
       "      <td>10696.53</td>\n",
       "      <td>CK30</td>\n",
       "      <td>JUSTIN A. JEFFREY</td>\n",
       "      <td>BLACKSTONE VALLEY PEDIATRIC &amp;</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>10679.673333</td>\n",
       "      <td>10640.750833</td>\n",
       "      <td>10583.91</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaT</td>\n",
       "      <td>3</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>448</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>Simple Business Checking</td>\n",
       "      <td>4965.63</td>\n",
       "      <td>4965.63</td>\n",
       "      <td>CK25</td>\n",
       "      <td>TIFFANY J. CAHILL</td>\n",
       "      <td>GREENVILLE COMMON PROPERTIES</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>856.356667</td>\n",
       "      <td>897.033333</td>\n",
       "      <td>752.74</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>182482.0</td>\n",
       "      <td>2021-12-02 17:32:20</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>4410</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>NOW Checking</td>\n",
       "      <td>125811.37</td>\n",
       "      <td>125811.37</td>\n",
       "      <td>CK05</td>\n",
       "      <td>JUSTIN A. JEFFREY</td>\n",
       "      <td>NARDO, MARTINO</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>100526.300000</td>\n",
       "      <td>134840.330000</td>\n",
       "      <td>74484.18</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>203764.0</td>\n",
       "      <td>2020-09-29 00:31:31</td>\n",
       "      <td>5</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62770</th>\n",
       "      <td>63024225</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>TD</td>\n",
       "      <td>6 Month Prime Time CD</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>CD25</td>\n",
       "      <td>MICHAEL A. HEY</td>\n",
       "      <td>COLEMAN, ELAINE M.</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>111269.0</td>\n",
       "      <td>2025-02-07 20:29:33</td>\n",
       "      <td>36229</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62771</th>\n",
       "      <td>63024233</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>SAV</td>\n",
       "      <td>Prime Time MM Passbook</td>\n",
       "      <td>850.07</td>\n",
       "      <td>850.07</td>\n",
       "      <td>SV01</td>\n",
       "      <td>MARLENE C. LIRA</td>\n",
       "      <td>MEDEIROS, VALDEMIRO D.</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>758.945000</td>\n",
       "      <td>758.945000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>147615.0</td>\n",
       "      <td>2025-02-07 20:29:33</td>\n",
       "      <td>1876</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62772</th>\n",
       "      <td>63024268</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>TD</td>\n",
       "      <td>6 Month Prime Time CD</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>CD25</td>\n",
       "      <td>MICHAEL A. HEY</td>\n",
       "      <td>COLEMAN, ELAINE M.</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>111269.0</td>\n",
       "      <td>2025-02-07 20:29:33</td>\n",
       "      <td>33649</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62773</th>\n",
       "      <td>63024306</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>TD</td>\n",
       "      <td>6 Month Prime Time CD</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>CD25</td>\n",
       "      <td>MICHAEL A. HEY</td>\n",
       "      <td>COLEMAN, ELAINE M.</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>111269.0</td>\n",
       "      <td>2025-02-07 20:29:33</td>\n",
       "      <td>40890</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62774</th>\n",
       "      <td>63024462</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>eChecking (18 &amp; over)</td>\n",
       "      <td>-4.66</td>\n",
       "      <td>-4.66</td>\n",
       "      <td>CK04</td>\n",
       "      <td>JACQUELINE A. THEIS</td>\n",
       "      <td>SOUZA, ALFRED D. III</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>99.325000</td>\n",
       "      <td>99.325000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>18</td>\n",
       "      <td>2</td>\n",
       "      <td>18</td>\n",
       "      <td>2</td>\n",
       "      <td>306312.0</td>\n",
       "      <td>2025-02-07 20:29:34</td>\n",
       "      <td>35113</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>62775 rows × 22 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "        acctnbr    effdate mjaccttypcd                      product  \\\n",
       "0           442 2025-04-02          CK     Simple Business Checking   \n",
       "1           444 2025-04-02          CK  Business Elite Money Market   \n",
       "2           445 2025-04-02          CK  Business Elite Money Market   \n",
       "3           448 2025-04-02          CK     Simple Business Checking   \n",
       "4          4410 2025-04-02          CK                 NOW Checking   \n",
       "...         ...        ...         ...                          ...   \n",
       "62770  63024225 2025-04-02          TD        6 Month Prime Time CD   \n",
       "62771  63024233 2025-04-02         SAV       Prime Time MM Passbook   \n",
       "62772  63024268 2025-04-02          TD        6 Month Prime Time CD   \n",
       "62773  63024306 2025-04-02          TD        6 Month Prime Time CD   \n",
       "62774  63024462 2025-04-02          CK        eChecking (18 & over)   \n",
       "\n",
       "         notebal  notemtdavgbal currmiaccttypcd          acctofficer  \\\n",
       "0       11452.51       11452.51            CK25    TIFFANY J. CAHILL   \n",
       "1       50810.21       50810.21            CK30       LAURA A. STACK   \n",
       "2       10696.53       10696.53            CK30    JUSTIN A. JEFFREY   \n",
       "3        4965.63        4965.63            CK25    TIFFANY J. CAHILL   \n",
       "4      125811.37      125811.37            CK05    JUSTIN A. JEFFREY   \n",
       "...          ...            ...             ...                  ...   \n",
       "62770   10000.00       10000.00            CD25       MICHAEL A. HEY   \n",
       "62771     850.07         850.07            SV01      MARLENE C. LIRA   \n",
       "62772   10000.00       10000.00            CD25       MICHAEL A. HEY   \n",
       "62773   10000.00       10000.00            CD25       MICHAEL A. HEY   \n",
       "62774      -4.66          -4.66            CK04  JACQUELINE A. THEIS   \n",
       "\n",
       "                        ownersortname curracctstatcd  ...     3Mo_AvgBal  \\\n",
       "0      PICKLES PLUMBING & HEATING LLC            ACT  ...    6820.500000   \n",
       "1                  THE PAWS GROUP LLC            ACT  ...   50730.136667   \n",
       "2       BLACKSTONE VALLEY PEDIATRIC &            ACT  ...   10679.673333   \n",
       "3        GREENVILLE COMMON PROPERTIES            ACT  ...     856.356667   \n",
       "4                      NARDO, MARTINO            ACT  ...  100526.300000   \n",
       "...                               ...            ...  ...            ...   \n",
       "62770              COLEMAN, ELAINE M.            ACT  ...    8928.570000   \n",
       "62771          MEDEIROS, VALDEMIRO D.            ACT  ...     758.945000   \n",
       "62772              COLEMAN, ELAINE M.            ACT  ...    8928.570000   \n",
       "62773              COLEMAN, ELAINE M.            ACT  ...    8928.570000   \n",
       "62774            SOUZA, ALFRED D. III            ACT  ...      99.325000   \n",
       "\n",
       "          TTM_AvgBal  Year Ago Balance  TTM_DAYS_OVERDRAWN  TTM_NSF_COUNT  \\\n",
       "0       10205.697500           3429.11                   0              0   \n",
       "1      329678.648333         430708.34                   0              0   \n",
       "2       10640.750833          10583.91                   0              0   \n",
       "3         897.033333            752.74                   0              0   \n",
       "4      134840.330000          74484.18                   0              0   \n",
       "...              ...               ...                 ...            ...   \n",
       "62770    8928.570000              0.00                   0              0   \n",
       "62771     758.945000              0.00                   0              0   \n",
       "62772    8928.570000              0.00                   0              0   \n",
       "62773    8928.570000              0.00                   0              0   \n",
       "62774      99.325000              0.00                  18              2   \n",
       "\n",
       "       YTD_DAYS_OVERDRAWN  YTD_NSF_COUNT  householdnbr       datelastmaint  \\\n",
       "0                       0              0      230804.0 2021-09-23 22:51:42   \n",
       "1                       0              0      229764.0 2023-10-30 13:17:29   \n",
       "2                       0              0           NaN                 NaT   \n",
       "3                       0              0      182482.0 2021-12-02 17:32:20   \n",
       "4                       0              0      203764.0 2020-09-29 00:31:31   \n",
       "...                   ...            ...           ...                 ...   \n",
       "62770                   0              0      111269.0 2025-02-07 20:29:33   \n",
       "62771                   0              0      147615.0 2025-02-07 20:29:33   \n",
       "62772                   0              0      111269.0 2025-02-07 20:29:33   \n",
       "62773                   0              0      111269.0 2025-02-07 20:29:33   \n",
       "62774                  18              2      306312.0 2025-02-07 20:29:34   \n",
       "\n",
       "       portfolio_key  \n",
       "0                  1  \n",
       "1                  2  \n",
       "2                  3  \n",
       "3                  4  \n",
       "4                  5  \n",
       "...              ...  \n",
       "62770          36229  \n",
       "62771           1876  \n",
       "62772          33649  \n",
       "62773          40890  \n",
       "62774          35113  \n",
       "\n",
       "[62775 rows x 22 columns]"
      ]
     },
     "execution_count": 11,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n",
      "RangeIndex: 62775 entries, 0 to 62774\n",
      "Data columns (total 22 columns):\n",
      " #   Column              Non-Null Count  Dtype         \n",
      "---  ------              --------------  -----         \n",
      " 0   acctnbr             62775 non-null  object        \n",
      " 1   effdate             62775 non-null  datetime64[ns]\n",
      " 2   mjaccttypcd         62775 non-null  object        \n",
      " 3   product             62775 non-null  object        \n",
      " 4   notebal             62775 non-null  float64       \n",
      " 5   notemtdavgbal       62775 non-null  float64       \n",
      " 6   currmiaccttypcd     62775 non-null  object        \n",
      " 7   acctofficer         62743 non-null  object        \n",
      " 8   ownersortname       62775 non-null  object        \n",
      " 9   curracctstatcd      62775 non-null  object        \n",
      " 10  contractdate        62774 non-null  datetime64[ns]\n",
      " 11  ytdavgbal           62775 non-null  float64       \n",
      " 12  3Mo_AvgBal          62775 non-null  float64       \n",
      " 13  TTM_AvgBal          62775 non-null  float64       \n",
      " 14  Year Ago Balance    62775 non-null  float64       \n",
      " 15  TTM_DAYS_OVERDRAWN  62775 non-null  int64         \n",
      " 16  TTM_NSF_COUNT       62775 non-null  int64         \n",
      " 17  YTD_DAYS_OVERDRAWN  62775 non-null  int64         \n",
      " 18  YTD_NSF_COUNT       62775 non-null  int64         \n",
      " 19  householdnbr        56811 non-null  float64       \n",
      " 20  datelastmaint       56811 non-null  datetime64[ns]\n",
      " 21  portfolio_key       62775 non-null  int64         \n",
      "dtypes: datetime64[ns](3), float64(7), int64(5), object(7)\n",
      "memory usage: 10.5+ MB\n"
     ]
    }
   ],
   "source": [
    "df.info()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "\"\"\"\n",
    "Main Entry Point\n",
    "\"\"\"\n",
    "from pathlib import Path\n",
    "\n",
    "import pandas as pd # type: ignore\n",
    "\n",
    "import cdutils.pkey_sqlite # type:ignore\n",
    "import src.core_transform\n",
    "import src.output_to_excel\n",
    "from src._version import __version__\n",
    "\n",
    "# def main(production_flag: bool=False):\n",
    "    # if production_flag:\n",
    "    #     BASE_PATH = Path(r'\\\\00-DA1\\Home\\Share\\Line of Business_Shared Services')\n",
    "    #     assert \"prod\" in __version__, (f\"Cannot run in production mode without 'prod' in the __version__\")\n",
    "    # else:\n",
    "    #     BASE_PATH = Path('.')\n",
    "\n",
    "# Get staging data from the daily deposit update. View dev section of documentation for more detail\n",
    "INPUT_PATH = Path(r\"\\\\00-da1\\Home\\Share\\Data & Analytics Initiatives\\Project Management\\Data_Analytics\\Daily_Deposit_Update\\Production\\output\\DailyDeposit_staging.xlsx\")\n",
    "data = pd.read_excel(INPUT_PATH)\n",
    "\n",
    "# Add portfolio key\n",
    "data = cdutils.pkey_sqlite.add_pkey(data)\n",
    "\n",
    "# Core transformation pipeline\n",
    "raw_data = src.core_transform.main_pipeline(data)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>portfolio_key</th>\n",
       "      <th>acctnbr</th>\n",
       "      <th>ownersortname</th>\n",
       "      <th>product</th>\n",
       "      <th>mjaccttypcd</th>\n",
       "      <th>currmiaccttypcd</th>\n",
       "      <th>acctofficer</th>\n",
       "      <th>notebal</th>\n",
       "      <th>curracctstatcd</th>\n",
       "      <th>contractdate</th>\n",
       "      <th>ytdavgbal</th>\n",
       "      <th>3Mo_AvgBal</th>\n",
       "      <th>TTM_AvgBal</th>\n",
       "      <th>Year Ago Balance</th>\n",
       "      <th>TTM_DAYS_OVERDRAWN</th>\n",
       "      <th>TTM_NSF_COUNT</th>\n",
       "      <th>YTD_DAYS_OVERDRAWN</th>\n",
       "      <th>YTD_NSF_COUNT</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>3840</td>\n",
       "      <td>27048209</td>\n",
       "      <td>PERFORMANCE FH INC</td>\n",
       "      <td>Business Checking</td>\n",
       "      <td>CK</td>\n",
       "      <td>CK12</td>\n",
       "      <td>DAMON T. ARPIN</td>\n",
       "      <td>3319508.39</td>\n",
       "      <td>ACT</td>\n",
       "      <td>2014-04-09 00:00:00</td>\n",
       "      <td>2849722.58</td>\n",
       "      <td>2836384.29</td>\n",
       "      <td>2822320.495</td>\n",
       "      <td>1781750.66</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>3840</td>\n",
       "      <td>27047237</td>\n",
       "      <td>FIRST AUTOMOTIVE GROUP INC</td>\n",
       "      <td>Business Checking</td>\n",
       "      <td>CK</td>\n",
       "      <td>CK12</td>\n",
       "      <td>JACQUELINE A. THEIS</td>\n",
       "      <td>750.0</td>\n",
       "      <td>ACT</td>\n",
       "      <td>2018-02-12 00:00:00</td>\n",
       "      <td>-36.31</td>\n",
       "      <td>-48.67</td>\n",
       "      <td>1745.83</td>\n",
       "      <td>2500.62</td>\n",
       "      <td>43</td>\n",
       "      <td>0</td>\n",
       "      <td>23</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>3840</td>\n",
       "      <td>27043282</td>\n",
       "      <td>492 WINTHROP ST LLC</td>\n",
       "      <td>Business Checking</td>\n",
       "      <td>CK</td>\n",
       "      <td>CK12</td>\n",
       "      <td>DAMON T. ARPIN</td>\n",
       "      <td>97656.29</td>\n",
       "      <td>ACT</td>\n",
       "      <td>2010-12-13 00:00:00</td>\n",
       "      <td>84239.92</td>\n",
       "      <td>83620.62</td>\n",
       "      <td>88140.2475</td>\n",
       "      <td>98653.03</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>3840</td>\n",
       "      <td>27037096</td>\n",
       "      <td>PERFORMANCE FH INC</td>\n",
       "      <td>Business Checking</td>\n",
       "      <td>CK</td>\n",
       "      <td>CK12</td>\n",
       "      <td>DAMON T. ARPIN</td>\n",
       "      <td>0.0</td>\n",
       "      <td>ACT</td>\n",
       "      <td>2018-02-12 00:00:00</td>\n",
       "      <td>478.53</td>\n",
       "      <td>456.546667</td>\n",
       "      <td>2006.269167</td>\n",
       "      <td>1093.17</td>\n",
       "      <td>4</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>3840</td>\n",
       "      <td>27042448</td>\n",
       "      <td>FIRST AUTOMOTIVE GROUP INC</td>\n",
       "      <td>Business Checking</td>\n",
       "      <td>CK</td>\n",
       "      <td>CK12</td>\n",
       "      <td>DAMON T. ARPIN</td>\n",
       "      <td>3820957.64</td>\n",
       "      <td>ACT</td>\n",
       "      <td>2014-04-09 00:00:00</td>\n",
       "      <td>3528591.83</td>\n",
       "      <td>3520782.343333</td>\n",
       "      <td>3341820.6775</td>\n",
       "      <td>2631679.88</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>107736</th>\n",
       "      <td>1430</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>-1301.15</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>-12.04</td>\n",
       "      <td>20.453333</td>\n",
       "      <td>193.851667</td>\n",
       "      <td>328.78</td>\n",
       "      <td>196</td>\n",
       "      <td>61</td>\n",
       "      <td>61</td>\n",
       "      <td>28</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>107737</th>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>107738</th>\n",
       "      <td>151</td>\n",
       "      <td>101756</td>\n",
       "      <td>COLANGELO, STEVEN J.</td>\n",
       "      <td>BCSB High Yield Checking</td>\n",
       "      <td>CK</td>\n",
       "      <td>CK35</td>\n",
       "      <td>JUSTIN A. JEFFREY</td>\n",
       "      <td>-3663.44</td>\n",
       "      <td>ACT</td>\n",
       "      <td>2004-03-22 00:00:00</td>\n",
       "      <td>-1645.64</td>\n",
       "      <td>-1654.133333</td>\n",
       "      <td>46.18</td>\n",
       "      <td>80.41</td>\n",
       "      <td>82</td>\n",
       "      <td>161</td>\n",
       "      <td>40</td>\n",
       "      <td>12</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>107739</th>\n",
       "      <td>151</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>-3663.44</td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td>-1645.64</td>\n",
       "      <td>-1654.133333</td>\n",
       "      <td>46.18</td>\n",
       "      <td>80.41</td>\n",
       "      <td>82</td>\n",
       "      <td>161</td>\n",
       "      <td>40</td>\n",
       "      <td>12</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>107740</th>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "      <td></td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>107741 rows × 18 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "       portfolio_key   acctnbr               ownersortname  \\\n",
       "0               3840  27048209          PERFORMANCE FH INC   \n",
       "1               3840  27047237  FIRST AUTOMOTIVE GROUP INC   \n",
       "2               3840  27043282         492 WINTHROP ST LLC   \n",
       "3               3840  27037096          PERFORMANCE FH INC   \n",
       "4               3840  27042448  FIRST AUTOMOTIVE GROUP INC   \n",
       "...              ...       ...                         ...   \n",
       "107736          1430                                         \n",
       "107737                                                       \n",
       "107738           151    101756        COLANGELO, STEVEN J.   \n",
       "107739           151                                         \n",
       "107740                                                       \n",
       "\n",
       "                          product mjaccttypcd currmiaccttypcd  \\\n",
       "0               Business Checking          CK            CK12   \n",
       "1               Business Checking          CK            CK12   \n",
       "2               Business Checking          CK            CK12   \n",
       "3               Business Checking          CK            CK12   \n",
       "4               Business Checking          CK            CK12   \n",
       "...                           ...         ...             ...   \n",
       "107736                                                          \n",
       "107737                                                          \n",
       "107738  BCSB High Yield Checking           CK            CK35   \n",
       "107739                                                          \n",
       "107740                                                          \n",
       "\n",
       "                acctofficer     notebal curracctstatcd         contractdate  \\\n",
       "0            DAMON T. ARPIN  3319508.39            ACT  2014-04-09 00:00:00   \n",
       "1       JACQUELINE A. THEIS       750.0            ACT  2018-02-12 00:00:00   \n",
       "2            DAMON T. ARPIN    97656.29            ACT  2010-12-13 00:00:00   \n",
       "3            DAMON T. ARPIN         0.0            ACT  2018-02-12 00:00:00   \n",
       "4            DAMON T. ARPIN  3820957.64            ACT  2014-04-09 00:00:00   \n",
       "...                     ...         ...            ...                  ...   \n",
       "107736                         -1301.15                                       \n",
       "107737                                                                        \n",
       "107738    JUSTIN A. JEFFREY    -3663.44            ACT  2004-03-22 00:00:00   \n",
       "107739                         -3663.44                                       \n",
       "107740                                                                        \n",
       "\n",
       "         ytdavgbal      3Mo_AvgBal    TTM_AvgBal Year Ago Balance  \\\n",
       "0       2849722.58      2836384.29   2822320.495       1781750.66   \n",
       "1           -36.31          -48.67       1745.83          2500.62   \n",
       "2         84239.92        83620.62    88140.2475         98653.03   \n",
       "3           478.53      456.546667   2006.269167          1093.17   \n",
       "4       3528591.83  3520782.343333  3341820.6775       2631679.88   \n",
       "...            ...             ...           ...              ...   \n",
       "107736      -12.04       20.453333    193.851667           328.78   \n",
       "107737                                                              \n",
       "107738    -1645.64    -1654.133333         46.18            80.41   \n",
       "107739    -1645.64    -1654.133333         46.18            80.41   \n",
       "107740                                                              \n",
       "\n",
       "       TTM_DAYS_OVERDRAWN TTM_NSF_COUNT YTD_DAYS_OVERDRAWN YTD_NSF_COUNT  \n",
       "0                       0             0                  0             0  \n",
       "1                      43             0                 23             0  \n",
       "2                       0             0                  0             0  \n",
       "3                       4             0                  0             0  \n",
       "4                       0             0                  0             0  \n",
       "...                   ...           ...                ...           ...  \n",
       "107736                196            61                 61            28  \n",
       "107737                                                                    \n",
       "107738                 82           161                 40            12  \n",
       "107739                 82           161                 40            12  \n",
       "107740                                                                    \n",
       "\n",
       "[107741 rows x 18 columns]"
      ]
     },
     "execution_count": 2,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "raw_data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [],
   "source": [
    "raw_data.to_excel(\"data_dump_cod.xlsx\", index=False, engine=\"openpyxl\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "import cdutils.database.connect # type: ignore\n",
    "from sqlalchemy import text # type: ignore\n",
    "# \n",
    "# lookup table\n",
    "# Engine 1\n",
    "lookup_df = text(\"\"\"\n",
    "SELECT \n",
    "    *\n",
    "FROM \n",
    "    sys.all_tab_columns col\n",
    "\"\"\")\n",
    "\n",
    "queries = [\n",
    "    # {'key':'acctcommon', 'sql':acctcommon, 'engine':2},\n",
    "    {'key':'lookup_df', 'sql':lookup_df, 'engine':1},\n",
    "]\n",
    "data = cdutils.database.connect.retrieve_data(queries)\n",
    "lookup_df = data['lookup_df'].copy()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "lookup_df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "def retrieve_data():\n",
    "    \"\"\"\n",
    "    Execute a SQL query against the COCC database. You can define whatever tables you want as separate dataframes\n",
    "\n",
    "    Args:\n",
    "        n/a\n",
    "\n",
    "    Returns:\n",
    "        data (dict): Dictionary (Key/Value pair) with all of the table names you set as keys and the values are the raw data tables from the SQL database\n",
    "    \"\"\"\n",
    "    wh_acctrole = text(\"\"\"\n",
    "    SELECT \n",
    "        *\n",
    "    FROM \n",
    "        OSIBANK.WH_ACCTROLE\n",
    "    \"\"\")\n",
    "\n",
    "    wh_allroles = text(\"\"\"\n",
    "    SELECT\n",
    "        *\n",
    "    FROM\n",
    "        OSIBANK.WH_ALLROLES a\n",
    "    \"\"\")\n",
    "\n",
    "    queries = [\n",
    "        # {'key':'acctcommon', 'sql':acctcommon, 'engine':2},\n",
    "        {'key':'wh_acctrole', 'sql':wh_acctrole, 'engine':1},\n",
    "        {'key':'wh_allroles', 'sql':wh_allroles, 'engine':1},\n",
    "    ]\n",
    "    data = cdutils.database.connect.retrieve_data(queries)\n",
    "    return data\n",
    "\n",
    "data = retrieve_data()\n",
    "wh_acctrole = data['wh_acctrole'].copy()\n",
    "wh_allroles = data['wh_allroles'].copy()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n",
      "RangeIndex: 460533 entries, 0 to 460532\n",
      "Data columns (total 7 columns):\n",
      " #   Column         Non-Null Count   Dtype         \n",
      "---  ------         --------------   -----         \n",
      " 0   acctnbr        460533 non-null  int64         \n",
      " 1   rundate        460533 non-null  datetime64[ns]\n",
      " 2   acctrolecd     460533 non-null  object        \n",
      " 3   persnbr        448181 non-null  float64       \n",
      " 4   acctroledesc   460533 non-null  object        \n",
      " 5   org_orgnbr     12352 non-null   float64       \n",
      " 6   datelastmaint  460533 non-null  datetime64[ns]\n",
      "dtypes: datetime64[ns](2), float64(2), int64(1), object(2)\n",
      "memory usage: 24.6+ MB\n"
     ]
    }
   ],
   "source": [
    "wh_acctrole.info()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n",
      "RangeIndex: 766539 entries, 0 to 766538\n",
      "Data columns (total 8 columns):\n",
      " #   Column         Non-Null Count   Dtype         \n",
      "---  ------         --------------   -----         \n",
      " 0   acctnbr        766539 non-null  int64         \n",
      " 1   acctrolecd     766539 non-null  object        \n",
      " 2   acctroledesc   766539 non-null  object        \n",
      " 3   emplroleyn     766539 non-null  object        \n",
      " 4   persnbr        732864 non-null  float64       \n",
      " 5   orgnbr         33675 non-null   float64       \n",
      " 6   rundate        766539 non-null  datetime64[ns]\n",
      " 7   datelastmaint  766539 non-null  datetime64[ns]\n",
      "dtypes: datetime64[ns](2), float64(2), int64(1), object(3)\n",
      "memory usage: 46.8+ MB\n"
     ]
    }
   ],
   "source": [
    "wh_allroles.info()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "array(['ACTO', 'MARE', 'NAGR', 'BENE', 'TRUS', 'OWN', 'CUST', 'EXEC',\n",
       "       'LNCO', 'SIGN', 'LOFF', 'POA', 'MAIL', 'OEMP', 'ATM', 'GUAR',\n",
       "       'LSET', 'GRDN', 'DBA', 'SELO', 'WARD', 'COUI', 'WWW', 'DECD',\n",
       "       'DEPU', 'BILL', 'PREP', 'MUTM', 'PRTN', 'RUTM', 'FIDU', 'ESC',\n",
       "       'BENO', 'POD', 'ASIG', 'STMT', 'UTMA', 'VRU', 'RPPY', 'TNNT',\n",
       "       'GRNT', 'LTOB', 'LAND', 'EXEX', 'ESCW', 'BURY', 'UNDR', 'EST',\n",
       "       'ADMN', 'ATTY', 'CONS', 'TRST', 'LLC', 'TENB'], dtype=object)"
      ]
     },
     "execution_count": 14,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "wh_acctrole['acctrolecd'].unique()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "array(['Account Officer', 'Mail Recipient', 'No WWW / VRU Agreement',\n",
       "       'Beneficiary', 'Trustee', 'NonTax Owner', 'Custodian', 'Executor',\n",
       "       'Loan Co/Signer', 'NonTax Signator', 'Lending Officer Role',\n",
       "       'Mail Care of:', 'Power of Attorney', 'Originating Employee',\n",
       "       'ATM Card Holder', 'Loan Setup', 'Authorized Signer', 'Guarantor',\n",
       "       'UTMA', 'Representative Payee', 'Statement', 'VRU Access Role',\n",
       "       'Executrix', 'Escrow Agent', 'Burial Fund', 'Underwriter',\n",
       "       'Estate', 'Administrator', 'Attorney', 'Conservator', 'Trust',\n",
       "       'Personal Rep', 'Landlord', 'WWW Access Role', 'MA UTMA',\n",
       "       'Partner', 'RI UTMA', 'Fiduciary', 'Escrow', 'Tenant', 'Deceased',\n",
       "       'Grantor', 'Loans To One Borrower', 'POD', 'Deputy', 'Loan Bill',\n",
       "       'Second Lending Officer', 'Beneficial Owner', 'Guardian', 'LLC',\n",
       "       'Tenant Building', 'DBA', 'Ward', 'Courier'], dtype=object)"
      ]
     },
     "execution_count": 5,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "wh_acctrole['acctroledesc'].unique()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "array(['Tax Owner', 'Tax Signator', 'NonTax Owner', 'NonTax Signator',\n",
       "       'Lending Officer Role', 'Originating Employee', 'Account Officer',\n",
       "       'Beneficiary', 'Trustee', 'Custodian', 'Second Lending Officer',\n",
       "       'Guarantor', 'WWW Access Role', 'Deceased', 'Personal Rep',\n",
       "       'Loan Co/Signer', 'Tenant', 'Authorized Signer', 'Escrow Agent',\n",
       "       'Deputy', 'Power of Attorney', 'Mail Care of:',\n",
       "       'Representative Payee', 'UTMA', 'Underwriter', 'Landlord', 'POD',\n",
       "       'MA UTMA', 'Guardian', 'Mail Recipient', 'Executor', 'Escrow',\n",
       "       'ATM Card Holder', 'Administrator', 'Grantor', 'Conservator',\n",
       "       'Loan Setup', 'Loan Bill', 'Estate', 'Ward', 'Statement',\n",
       "       'Fiduciary', 'Courier', 'Attorney', 'Beneficial Owner', 'Trust',\n",
       "       'Executrix', 'No WWW / VRU Agreement', 'Burial Fund', 'RI UTMA',\n",
       "       'Partner', 'Loans To One Borrower', 'VRU Access Role', 'DBA',\n",
       "       'Tenant Building', 'LLC'], dtype=object)"
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "wh_allroles['acctroledesc'].unique()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "\n",
    "def fetch_data():\n",
    "    wh_acctcommon = text(\"\"\"\n",
    "    SELECT\n",
    "        a.EFFDATE,\n",
    "        a.ACCTNBR,\n",
    "        a.PRODUCT,\n",
    "        a.ACCTOFFICER,\n",
    "        a.OWNERSORTNAME,\n",
    "        a.MJACCTTYPCD,\n",
    "        a.CURRMIACCTTYPCD,\n",
    "        a.CURRACCTSTATCD,\n",
    "        a.NOTEINTRATE,\n",
    "        a.BOOKBALANCE,\n",
    "        a.NOTEBAL,\n",
    "        a.CONTRACTDATE,\n",
    "        a.CLOSEDATE\n",
    "    FROM\n",
    "        OSIBANK.WH_ACCTCOMMON a\n",
    "    WHERE\n",
    "        (a.CURRACCTSTATCD IN ('ACT','DORM')) AND\n",
    "        (a.MJACCTTYPCD IN ('CK','SAV','TD'))\n",
    "    \"\"\")\n",
    "\n",
    "queries = [\n",
    "    {'key':'wh_acctcommon', 'sql':wh_acctcommon, 'engine':1},\n",
    "]\n",
    "\n",
    "data = cdutils.database.connect.retrieve_data(queries)\n",
    "return data\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Function to add SELO\n",
    "def add_selo(df):\n",
    "    \"\"\"\n",
    "    Add secondary lending officer\n",
    "    \"\"\"\n",
    "    def retrieve_data():\n",
    "        \"\"\"\n",
    "        Execute a SQL query against the COCC database. You can define whatever tables you want as separate dataframes\n",
    "\n",
    "        Args:\n",
    "            n/a\n",
    "\n",
    "        Returns:\n",
    "            data (dict): Dictionary (Key/Value pair) with all of the table names you set as keys and the values are the raw data tables from the SQL database\n",
    "        \"\"\"\n",
    "        wh_acctrole = text(\"\"\"\n",
    "        SELECT \n",
    "            *\n",
    "        FROM \n",
    "            OSIBANK.WH_ACCTROLE\n",
    "        \"\"\")\n",
    "\n",
    "        wh_pers = text(\"\"\"\n",
    "        SELECT\n",
    "            a.PERSNBR,\n",
    "            a.PERSNAME\n",
    "        FROM\n",
    "            OSIBANK.WH_PERS a\n",
    "        \"\"\")\n",
    "\n",
    "        queries = [\n",
    "            # {'key':'acctcommon', 'sql':acctcommon, 'engine':2},\n",
    "            {'key':'wh_acctrole', 'sql':wh_acctrole, 'engine':1},\n",
    "            {'key':'wh_pers', 'sql':wh_pers, 'engine':1},\n",
    "        ]\n",
    "        data = cdutils.database.connect.retrieve_data(queries)\n",
    "        return data\n",
    "\n",
    "    data = retrieve_data()\n",
    "    wh_acctrole = data['wh_acctrole'].copy()\n",
    "    wh_pers = data['wh_pers'].copy()\n",
    "    return \n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "data = df[[\n",
    "    'portfolio_key',\n",
    "    'acctnbr',\n",
    "    'ownersortname',\n",
    "    'product',\n",
    "    'mjaccttypcd',\n",
    "    'currmiaccttypcd',\n",
    "    'acctofficer',\n",
    "    'curracctstatcd',\n",
    "    'contractdate',\n",
    "    'ytdavgbal',\n",
    "    '3Mo_AvgBal',\n",
    "    'TTM_AvgBal',\n",
    "    'Year Ago Balance',\n",
    "    'TTM_DAYS_OVERDRAWN',\n",
    "    'TTM_NSF_COUNT',\n",
    "    'YTD_DAYS_OVERDRAWN',\n",
    "    'YTD_NSF_COUNT'\n",
    "    ]].copy()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "Acctnbr, pkey, product, customer name, acct officer, contract date, acctstatus, bookbal, noteintrate, trailing 3 mo bal, trailing 12 month bal, # ODs, # NSF, orgnbr, persnbr\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "HI\n"
     ]
    }
   ],
   "source": [
    "import cdutils.random # type:ignore\n",
    "cdutils.random.print_hi()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>acctnbr</th>\n",
       "      <th>effdate</th>\n",
       "      <th>mjaccttypcd</th>\n",
       "      <th>product</th>\n",
       "      <th>notebal</th>\n",
       "      <th>notemtdavgbal</th>\n",
       "      <th>currmiaccttypcd</th>\n",
       "      <th>acctofficer</th>\n",
       "      <th>ownersortname</th>\n",
       "      <th>curracctstatcd</th>\n",
       "      <th>...</th>\n",
       "      <th>3Mo_AvgBal</th>\n",
       "      <th>TTM_AvgBal</th>\n",
       "      <th>Year Ago Balance</th>\n",
       "      <th>TTM_DAYS_OVERDRAWN</th>\n",
       "      <th>TTM_NSF_COUNT</th>\n",
       "      <th>YTD_DAYS_OVERDRAWN</th>\n",
       "      <th>YTD_NSF_COUNT</th>\n",
       "      <th>householdnbr</th>\n",
       "      <th>datelastmaint</th>\n",
       "      <th>portfolio_key</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>442</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>Simple Business Checking</td>\n",
       "      <td>11452.51</td>\n",
       "      <td>11452.51</td>\n",
       "      <td>CK25</td>\n",
       "      <td>TIFFANY J. CAHILL</td>\n",
       "      <td>PICKLES PLUMBING &amp; HEATING LLC</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>6820.500000</td>\n",
       "      <td>10205.697500</td>\n",
       "      <td>3429.11</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>230804.0</td>\n",
       "      <td>2021-09-23 22:51:42</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>444</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>Business Elite Money Market</td>\n",
       "      <td>50810.21</td>\n",
       "      <td>50810.21</td>\n",
       "      <td>CK30</td>\n",
       "      <td>LAURA A. STACK</td>\n",
       "      <td>THE PAWS GROUP LLC</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>50730.136667</td>\n",
       "      <td>329678.648333</td>\n",
       "      <td>430708.34</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>229764.0</td>\n",
       "      <td>2023-10-30 13:17:29</td>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>445</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>Business Elite Money Market</td>\n",
       "      <td>10696.53</td>\n",
       "      <td>10696.53</td>\n",
       "      <td>CK30</td>\n",
       "      <td>JUSTIN A. JEFFREY</td>\n",
       "      <td>BLACKSTONE VALLEY PEDIATRIC &amp;</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>10679.673333</td>\n",
       "      <td>10640.750833</td>\n",
       "      <td>10583.91</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaT</td>\n",
       "      <td>3</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>448</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>Simple Business Checking</td>\n",
       "      <td>4965.63</td>\n",
       "      <td>4965.63</td>\n",
       "      <td>CK25</td>\n",
       "      <td>TIFFANY J. CAHILL</td>\n",
       "      <td>GREENVILLE COMMON PROPERTIES</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>856.356667</td>\n",
       "      <td>897.033333</td>\n",
       "      <td>752.74</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>182482.0</td>\n",
       "      <td>2021-12-02 17:32:20</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>4410</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>NOW Checking</td>\n",
       "      <td>125811.37</td>\n",
       "      <td>125811.37</td>\n",
       "      <td>CK05</td>\n",
       "      <td>JUSTIN A. JEFFREY</td>\n",
       "      <td>NARDO, MARTINO</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>100526.300000</td>\n",
       "      <td>134840.330000</td>\n",
       "      <td>74484.18</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>203764.0</td>\n",
       "      <td>2020-09-29 00:31:31</td>\n",
       "      <td>5</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62770</th>\n",
       "      <td>63024225</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>TD</td>\n",
       "      <td>6 Month Prime Time CD</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>CD25</td>\n",
       "      <td>MICHAEL A. HEY</td>\n",
       "      <td>COLEMAN, ELAINE M.</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>111269.0</td>\n",
       "      <td>2025-02-07 20:29:33</td>\n",
       "      <td>36229</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62771</th>\n",
       "      <td>63024233</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>SAV</td>\n",
       "      <td>Prime Time MM Passbook</td>\n",
       "      <td>850.07</td>\n",
       "      <td>850.07</td>\n",
       "      <td>SV01</td>\n",
       "      <td>MARLENE C. LIRA</td>\n",
       "      <td>MEDEIROS, VALDEMIRO D.</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>758.945000</td>\n",
       "      <td>758.945000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>147615.0</td>\n",
       "      <td>2025-02-07 20:29:33</td>\n",
       "      <td>1876</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62772</th>\n",
       "      <td>63024268</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>TD</td>\n",
       "      <td>6 Month Prime Time CD</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>CD25</td>\n",
       "      <td>MICHAEL A. HEY</td>\n",
       "      <td>COLEMAN, ELAINE M.</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>111269.0</td>\n",
       "      <td>2025-02-07 20:29:33</td>\n",
       "      <td>33649</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62773</th>\n",
       "      <td>63024306</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>TD</td>\n",
       "      <td>6 Month Prime Time CD</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>10000.00</td>\n",
       "      <td>CD25</td>\n",
       "      <td>MICHAEL A. HEY</td>\n",
       "      <td>COLEMAN, ELAINE M.</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>8928.570000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>111269.0</td>\n",
       "      <td>2025-02-07 20:29:33</td>\n",
       "      <td>40890</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62774</th>\n",
       "      <td>63024462</td>\n",
       "      <td>2025-04-02</td>\n",
       "      <td>CK</td>\n",
       "      <td>eChecking (18 &amp; over)</td>\n",
       "      <td>-4.66</td>\n",
       "      <td>-4.66</td>\n",
       "      <td>CK04</td>\n",
       "      <td>JACQUELINE A. THEIS</td>\n",
       "      <td>SOUZA, ALFRED D. III</td>\n",
       "      <td>ACT</td>\n",
       "      <td>...</td>\n",
       "      <td>99.325000</td>\n",
       "      <td>99.325000</td>\n",
       "      <td>0.00</td>\n",
       "      <td>18</td>\n",
       "      <td>2</td>\n",
       "      <td>18</td>\n",
       "      <td>2</td>\n",
       "      <td>306312.0</td>\n",
       "      <td>2025-02-07 20:29:34</td>\n",
       "      <td>35113</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>62775 rows × 22 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "        acctnbr    effdate mjaccttypcd                      product  \\\n",
       "0           442 2025-04-02          CK     Simple Business Checking   \n",
       "1           444 2025-04-02          CK  Business Elite Money Market   \n",
       "2           445 2025-04-02          CK  Business Elite Money Market   \n",
       "3           448 2025-04-02          CK     Simple Business Checking   \n",
       "4          4410 2025-04-02          CK                 NOW Checking   \n",
       "...         ...        ...         ...                          ...   \n",
       "62770  63024225 2025-04-02          TD        6 Month Prime Time CD   \n",
       "62771  63024233 2025-04-02         SAV       Prime Time MM Passbook   \n",
       "62772  63024268 2025-04-02          TD        6 Month Prime Time CD   \n",
       "62773  63024306 2025-04-02          TD        6 Month Prime Time CD   \n",
       "62774  63024462 2025-04-02          CK        eChecking (18 & over)   \n",
       "\n",
       "         notebal  notemtdavgbal currmiaccttypcd          acctofficer  \\\n",
       "0       11452.51       11452.51            CK25    TIFFANY J. CAHILL   \n",
       "1       50810.21       50810.21            CK30       LAURA A. STACK   \n",
       "2       10696.53       10696.53            CK30    JUSTIN A. JEFFREY   \n",
       "3        4965.63        4965.63            CK25    TIFFANY J. CAHILL   \n",
       "4      125811.37      125811.37            CK05    JUSTIN A. JEFFREY   \n",
       "...          ...            ...             ...                  ...   \n",
       "62770   10000.00       10000.00            CD25       MICHAEL A. HEY   \n",
       "62771     850.07         850.07            SV01      MARLENE C. LIRA   \n",
       "62772   10000.00       10000.00            CD25       MICHAEL A. HEY   \n",
       "62773   10000.00       10000.00            CD25       MICHAEL A. HEY   \n",
       "62774      -4.66          -4.66            CK04  JACQUELINE A. THEIS   \n",
       "\n",
       "                        ownersortname curracctstatcd  ...     3Mo_AvgBal  \\\n",
       "0      PICKLES PLUMBING & HEATING LLC            ACT  ...    6820.500000   \n",
       "1                  THE PAWS GROUP LLC            ACT  ...   50730.136667   \n",
       "2       BLACKSTONE VALLEY PEDIATRIC &            ACT  ...   10679.673333   \n",
       "3        GREENVILLE COMMON PROPERTIES            ACT  ...     856.356667   \n",
       "4                      NARDO, MARTINO            ACT  ...  100526.300000   \n",
       "...                               ...            ...  ...            ...   \n",
       "62770              COLEMAN, ELAINE M.            ACT  ...    8928.570000   \n",
       "62771          MEDEIROS, VALDEMIRO D.            ACT  ...     758.945000   \n",
       "62772              COLEMAN, ELAINE M.            ACT  ...    8928.570000   \n",
       "62773              COLEMAN, ELAINE M.            ACT  ...    8928.570000   \n",
       "62774            SOUZA, ALFRED D. III            ACT  ...      99.325000   \n",
       "\n",
       "          TTM_AvgBal  Year Ago Balance  TTM_DAYS_OVERDRAWN  TTM_NSF_COUNT  \\\n",
       "0       10205.697500           3429.11                   0              0   \n",
       "1      329678.648333         430708.34                   0              0   \n",
       "2       10640.750833          10583.91                   0              0   \n",
       "3         897.033333            752.74                   0              0   \n",
       "4      134840.330000          74484.18                   0              0   \n",
       "...              ...               ...                 ...            ...   \n",
       "62770    8928.570000              0.00                   0              0   \n",
       "62771     758.945000              0.00                   0              0   \n",
       "62772    8928.570000              0.00                   0              0   \n",
       "62773    8928.570000              0.00                   0              0   \n",
       "62774      99.325000              0.00                  18              2   \n",
       "\n",
       "       YTD_DAYS_OVERDRAWN  YTD_NSF_COUNT  householdnbr       datelastmaint  \\\n",
       "0                       0              0      230804.0 2021-09-23 22:51:42   \n",
       "1                       0              0      229764.0 2023-10-30 13:17:29   \n",
       "2                       0              0           NaN                 NaT   \n",
       "3                       0              0      182482.0 2021-12-02 17:32:20   \n",
       "4                       0              0      203764.0 2020-09-29 00:31:31   \n",
       "...                   ...            ...           ...                 ...   \n",
       "62770                   0              0      111269.0 2025-02-07 20:29:33   \n",
       "62771                   0              0      147615.0 2025-02-07 20:29:33   \n",
       "62772                   0              0      111269.0 2025-02-07 20:29:33   \n",
       "62773                   0              0      111269.0 2025-02-07 20:29:33   \n",
       "62774                  18              2      306312.0 2025-02-07 20:29:34   \n",
       "\n",
       "       portfolio_key  \n",
       "0                  1  \n",
       "1                  2  \n",
       "2                  3  \n",
       "3                  4  \n",
       "4                  5  \n",
       "...              ...  \n",
       "62770          36229  \n",
       "62771           1876  \n",
       "62772          33649  \n",
       "62773          40890  \n",
       "62774          35113  \n",
       "\n",
       "[62775 rows x 22 columns]"
      ]
     },
     "execution_count": 3,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "\n",
    "# Core transformation pipeline\n",
    "raw_data = src.core_transform.main_pipeline(data)\n",
    "\n",
    "# Output to excel (raw data)\n",
    "OUTPUT_PATH = BASE_PATH / Path('./output/standard_report.xlsx')\n",
    "raw_data.to_excel(OUTPUT_PATH, sheet_name='Sheet1', index=False)\n",
    "\n",
    "# Format excel\n",
    "src.output_to_excel.format_excel_file(OUTPUT_PATH)\n",
    "\n",
    "# if __name__ == '__main__':\n",
    "#     print(f\"Starting [{__version__}]\")\n",
    "#     # main(production_flag=True)\n",
    "#     main()\n",
    "    # print(\"Complete!\")\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [],
   "source": [
    "# pkey_sqlite.py\n",
    "import sqlite3\n",
    "from datetime import datetime\n",
    "from pathlib import Path\n",
    "import os\n",
    "\n",
    "from sqlalchemy import create_engine, inspect, text # type: ignore\n",
    "import pandas as pd # type: ignore\n",
    "\n",
    "def create_sqlite_engine(db_filename: str, use_default_dir: bool = True, base_dir: Path = None):\n",
    "    \"\"\"\n",
    "    Create a SQLAlchemy engine to interface with sqlite db\n",
    "    \"\"\"\n",
    "    if use_default_dir:\n",
    "        assets_dir = Path('.') / 'assets'\n",
    "        assets_dir.mkdir(parents=True, exist_ok=True)\n",
    "        db_path = assets_dir / db_filename\n",
    "    else:\n",
    "        if base_dir is None:\n",
    "            raise ValueError(\"You must provide a valid Path object when using use_default_dir=False\")\n",
    "        base_dir.mkdir(parents=True, exist_ok=True)\n",
    "        db_path = base_dir / db_filename\n",
    "\n",
    "    # build connection string\n",
    "    connection_str = f\"sqlite:///{db_path.resolve()}\"\n",
    "    engine = create_engine(connection_str)\n",
    "    return engine\n",
    "\n",
    "def get_most_recent_historical_key(engine, table_name: str='historical_keys') -> pd.DataFrame:\n",
    "    \"\"\"\n",
    "    Retrieves rows from sqlite db for most recent date\n",
    "    \"\"\"\n",
    "    inspector = inspect(engine)\n",
    "    if table_name not in inspector.get_table_names():\n",
    "        return None\n",
    "    \n",
    "    with engine.connect() as conn:\n",
    "\n",
    "        # Get max timestamp\n",
    "        max_timestamp_query = text(f\"\"\"\n",
    "        SELECT\n",
    "            MAX(timestamp) as timestamp\n",
    "        FROM\n",
    "            {table_name}\n",
    "        \"\"\"\n",
    "        )\n",
    "\n",
    "        result = conn.execute(max_timestamp_query)\n",
    "        max_timestamp = result.scalar()\n",
    "\n",
    "        if not max_timestamp:\n",
    "            return None\n",
    "        \n",
    "    query = text(f\"\"\"\n",
    "    SELECT\n",
    "        *\n",
    "    FROM\n",
    "        {table_name}\n",
    "    WHERE\n",
    "        timestamp = '{max_timestamp}'\n",
    "    \"\"\"\n",
    "    )\n",
    "    df = pd.read_sql(query, con=engine)\n",
    "    df['acctnbr'] = df['acctnbr'].astype(int)\n",
    "\n",
    "    return df\n",
    "\n",
    "def query_current_db(engine):\n",
    "    query = text(f\"\"\"\n",
    "    SELECT\n",
    "        *\n",
    "    FROM\n",
    "        current_keys\n",
    "    \"\"\")\n",
    "    df = pd.read_sql(query, con=engine)\n",
    "    df['acctnbr'] = df['acctnbr'].astype(int)\n",
    "    return df\n",
    "\n",
    "def write_current_run_to_current_db(df: pd.DataFrame, engine, table_name: str='current_keys'):\n",
    "    \"\"\"\n",
    "    Update current.db\n",
    "    \"\"\"\n",
    "    df.to_sql(table_name, con=engine, if_exists='replace', index=False)\n",
    "\n",
    "def append_records_to_historical_db(df: pd.DataFrame, engine, table_name: str='historical_keys'):\n",
    "    \"\"\"\n",
    "    Append most recent run to historical db with timestamp\n",
    "    \"\"\"\n",
    "    curr_timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n",
    "    df['timestamp'] = curr_timestamp\n",
    "    df.to_sql(table_name, con=engine, if_exists='append', index=False)\n",
    "\n",
    "\n",
    "def add_pkey(df: pd.DataFrame) -> pd.DataFrame:\n",
    "    \"\"\"\n",
    "    Add portfolio key from the R360 process to the dataframe that is passed in as an arguement\n",
    "\n",
    "    Args:\n",
    "        df (pd.DataFrame): Any dataframe can be passed in as long as it has the \"acctnbr\" field\n",
    "\n",
    "    Returns:\n",
    "        df (pd.DataFrame): Dataframe with pkey appended\n",
    "\n",
    "\n",
    "    Operations:\n",
    "    - extract pkey from the current.db (or Data Warehouse in future implementations)\n",
    "        - this is currently a sqlite.db that is updated on a daily basis to get the current groupings for all relationships\n",
    "    - append pkey to the dataframe by grouping on acctnbr and doing a left join\n",
    "\n",
    "    Tests/Asserts:\n",
    "    - Test that acctnbr exists in df\n",
    "    - Assert the datatypes of acctnbr are the same in both of the dataframes that are being joined\n",
    "    - current.db exists (if someone moved it or the drive is offline, this will fail)\n",
    "    \"\"\"\n",
    "\n",
    "    # Assert that df is not None\n",
    "    assert df is not None, \"Dataframe must not be none\"\n",
    "\n",
    "    DB_PATH = Path(r\"\\\\00-da1\\Home\\Share\\Data & Analytics Initiatives\\Project Management\\Data_Analytics\\R360\\Production\\assets\")\n",
    "\n",
    "    # Asserts that the pkey database exists\n",
    "    assert DB_PATH.exists(), f\"Directory that houses pkey not accessible\"\n",
    "    assert (DB_PATH / \"current.db\").exists(), f\"current.db does not exist or is not accesible\"\n",
    "\n",
    "    engine = create_sqlite_engine('current.db', use_default_dir=False, base_dir=DB_PATH)\n",
    "    pkey_df = pd.read_sql(\"SELECT * FROM current_keys\", con=engine)\n",
    "    pkey_df['acctnbr'] = pkey_df['acctnbr'].astype(str)\n",
    "    df['acctnbr'] = pkey_df['acctnbr'].astype(str)\n",
    "\n",
    "    # Assert \n",
    "    assert pd.api.types.is_string_dtype(pkey_df['acctnbr']), \"acctnbr is not a string\"\n",
    "    assert pd.api.types.is_string_dtype(df['acctnbr']), \"acctnbr is not a string\"\n",
    "\n",
    "    df = pd.merge(df, pkey_df, on='acctnbr', how='left')\n",
    "\n",
    "    return df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "ename": "NameError",
     "evalue": "name 'df' is not defined",
     "output_type": "error",
     "traceback": [
      "\u001b[31m---------------------------------------------------------------------------\u001b[39m",
      "\u001b[31mNameError\u001b[39m                                 Traceback (most recent call last)",
      "\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[6]\u001b[39m\u001b[32m, line 10\u001b[39m\n\u001b[32m      8\u001b[39m pkey_df = pd.read_sql(\u001b[33m\"\u001b[39m\u001b[33mSELECT * FROM current_keys\u001b[39m\u001b[33m\"\u001b[39m, con=engine)\n\u001b[32m      9\u001b[39m pkey_df[\u001b[33m'\u001b[39m\u001b[33macctnbr\u001b[39m\u001b[33m'\u001b[39m] = pkey_df[\u001b[33m'\u001b[39m\u001b[33macctnbr\u001b[39m\u001b[33m'\u001b[39m].astype(\u001b[38;5;28mstr\u001b[39m)\n\u001b[32m---> \u001b[39m\u001b[32m10\u001b[39m \u001b[43mdf\u001b[49m[\u001b[33m'\u001b[39m\u001b[33macctnbr\u001b[39m\u001b[33m'\u001b[39m] = pkey_df[\u001b[33m'\u001b[39m\u001b[33macctnbr\u001b[39m\u001b[33m'\u001b[39m].astype(\u001b[38;5;28mstr\u001b[39m)\n",
      "\u001b[31mNameError\u001b[39m: name 'df' is not defined"
     ]
    }
   ],
   "source": [
    "DB_PATH = Path(r\"\\\\00-da1\\Home\\Share\\Data & Analytics Initiatives\\Project Management\\Data_Analytics\\R360\\Production\\assets\")\n",
    "\n",
    "# Asserts that the pkey database exists\n",
    "assert DB_PATH.exists(), f\"Directory that houses pkey not accessible\"\n",
    "assert (DB_PATH / \"current.db\").exists(), f\"current.db does not exist or is not accesible\"\n",
    "\n",
    "engine = create_sqlite_engine('current.db', use_default_dir=False, base_dir=DB_PATH)\n",
    "pkey_df = pd.read_sql(\"SELECT * FROM current_keys\", con=engine)\n",
    "pkey_df['acctnbr'] = pkey_df['acctnbr'].astype(str)\n",
    "df['acctnbr'] = pkey_df['acctnbr'].astype(str)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>acctnbr</th>\n",
       "      <th>portfolio_key</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>442</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>444</td>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>445</td>\n",
       "      <td>3</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>448</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>4410</td>\n",
       "      <td>5</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>168485</th>\n",
       "      <td>600282583942</td>\n",
       "      <td>87177</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>168486</th>\n",
       "      <td>600283181885</td>\n",
       "      <td>33610</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>168487</th>\n",
       "      <td>4002786570099</td>\n",
       "      <td>40207</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>168488</th>\n",
       "      <td>4002786570103</td>\n",
       "      <td>40207</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>168489</th>\n",
       "      <td>99999162510504</td>\n",
       "      <td>1293</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>168490 rows × 2 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "               acctnbr  portfolio_key\n",
       "0                  442              1\n",
       "1                  444              2\n",
       "2                  445              3\n",
       "3                  448              4\n",
       "4                 4410              5\n",
       "...                ...            ...\n",
       "168485    600282583942          87177\n",
       "168486    600283181885          33610\n",
       "168487   4002786570099          40207\n",
       "168488   4002786570103          40207\n",
       "168489  99999162510504           1293\n",
       "\n",
       "[168490 rows x 2 columns]"
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "pkey_df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Function to add interest rate\n",
    "def add_noteintrate(df):\n",
    "    \"\"\"\n",
    "    Add interest rate\n",
    "    \"\"\"\n",
    "    def retrieve_data():\n",
    "        \"\"\"\n",
    "        Execute a SQL query against the COCC database. You can define whatever tables you want as separate dataframes\n",
    "\n",
    "        Args:\n",
    "            n/a\n",
    "\n",
    "        Returns:\n",
    "            data (dict): Dictionary (Key/Value pair) with all of the table names you set as keys and the values are the raw data tables from the SQL database\n",
    "        \"\"\"\n",
    "        acctcommon = text(\"\"\"\n",
    "        SELECT \n",
    "            a.ACCTNBR,\n",
    "            a.NOTEINTRATE\n",
    "        FROM \n",
    "            OSIBANK.WH_ACCTCOMMON\n",
    "        \"\"\")\n",
    "\n",
    "        queries = [\n",
    "            {'key':'acctcommon', 'sql':acctcommon, 'engine':1},\n",
    "        ]\n",
    "        data = cdutils.database.connect.retrieve_data(queries)\n",
    "        return data\n",
    "\n",
    "    data = retrieve_data()\n",
    "    acctcommon = data['acctcommon'].copy()\n",
    "    acctcommon['acctnbr'] = acctcommon['acctnbr'].astype(str)\n",
    "\n",
    "    # Asserts\n",
    "    assert df is not None\n",
    "    assert pd.api.types.is_string_dtype(df['acctnbr']), \"acctnbr is not a string\"\n",
    "    \n",
    "    df = pd.merge(df, acctcommon, on='acctnbr', how='left')\n",
    "\n",
    "    return df\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "import cdutils.deduplication # type: ignore\n",
    "import cdutils.database.connect # type: ignore\n",
    "import cdutils.input_cleansing # type: ignore\n",
    "from sqlalchemy import text # type: ignore\n",
    "import pandas as pd\n",
    "\n",
    "def fetch_from_allroles():\n",
    "        \"\"\"\n",
    "        Gets data from COCC\n",
    "        \"\"\"\n",
    "        wh_allroles = text(f\"\"\"\n",
    "        SELECT\n",
    "            *\n",
    "        FROM \n",
    "            OSIBANK.WH_ALLROLES a\n",
    "        \"\"\")\n",
    "\n",
    "        wh_pers = text(f\"\"\"\n",
    "        SELECT\n",
    "            *\n",
    "        FROM\n",
    "            OSIBANK.WH_PERS a\n",
    "        \"\"\")\n",
    "\n",
    "        queries = [\n",
    "            {'key':'wh_allroles', 'sql':wh_allroles, 'engine':1},\n",
    "            {'key':'wh_pers', 'sql':wh_pers, 'engine':1},\n",
    "        ]\n",
    "\n",
    "        data = cdutils.database.connect.retrieve_data(queries)\n",
    "        return data\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "\n",
    "\n",
    "# def append_selo(df: pd.DataFrame):\n",
    "  \n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [],
   "source": [
    "def append_cmo(df: pd.DataFrame) -> pd.DataFrame:\n",
    "    \"\"\"\n",
    "    Append Cash management officer to any dataframe\n",
    "    \"\"\"\n",
    "    data = fetch_from_allroles()\n",
    "\n",
    "    wh_allroles = data['wh_allroles'].copy()\n",
    "    wh_pers = data['wh_pers'].copy()\n",
    "\n",
    "    cmo = wh_allroles[wh_allroles['acctrolecd'] == 'CMO'].copy()\n",
    "\n",
    "    if cmo.empty:\n",
    "        return df\n",
    "\n",
    "    cmo = cmo.sort_values(by='datelastmaint', ascending=False).copy()\n",
    "    cmo = cdutils.deduplication.dedupe([{'df':cmo, 'field':'acctnbr'}])\n",
    "\n",
    "    pers = wh_pers.sort_values(by='datelastmaint', ascending=False).copy()\n",
    "    pers = cdutils.deduplication.dedupe([{'df':pers, 'field':'persnbr'}])\n",
    "\n",
    "    # Asserts\n",
    "    assert cmo['acctnbr'].is_unique, \"cmo not unique on acctnbr\"\n",
    "    assert pers['persnbr'].is_unique, \"pers not unique on persnbr\"\n",
    "\n",
    "\n",
    "    cmo = cmo[['acctnbr','persnbr']].copy()\n",
    "    pers = pers[['persnbr','perssortname']].copy()\n",
    "\n",
    "\n",
    "    merged_df = pd.merge(cmo, pers, on='persnbr',how='left')\n",
    "\n",
    "    merged_df = merged_df[['acctnbr','perssortname']].copy()\n",
    "    merged_df = merged_df.rename(columns={'perssortname':'Secondary Lending Officer'}).copy()\n",
    "\n",
    "    schema_df = {\n",
    "        'acctnbr': str,\n",
    "    }\n",
    "\n",
    "    df = cdutils.input_cleansing.enforce_schema(df, schema_df)\n",
    "\n",
    "    schema_merged_df = {\n",
    "            'acctnbr': str,\n",
    "        }\n",
    "\n",
    "    merged_df = cdutils.input_cleansing.enforce_schema(merged_df, schema_merged_df)\n",
    "\n",
    "    assert df['acctnbr'].is_unique, \"acctnbr not unique in df\"\n",
    "\n",
    "    final_df = pd.merge(df, merged_df, on='acctnbr', how='left')\n",
    "\n",
    "    return final_df\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [],
   "source": [
    "df = pd.DataFrame({'field1':[1,2,3]})\n",
    "import cdutils.cmo_append # type:ignore\n",
    "df = cdutils.cmo_append.append_cmo(df)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>field1</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>3</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   field1\n",
       "0       1\n",
       "1       2\n",
       "2       3"
      ]
     },
     "execution_count": 8,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "\n",
    "\n",
    "\n",
    "df\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": ".venv",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.9"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
```

## code_1.2.0.ipynb

```text
{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "0974a033",
   "metadata": {},
   "outputs": [],
   "source": [
    "\"\"\"\n",
    "Main Entry Point\n",
    "\"\"\"\n",
    "from pathlib import Path\n",
    "\n",
    "import pandas as pd # type: ignore\n",
    "\n",
    "import cdutils.pkey_sqlite # type: ignore\n",
    "import cdutils.filtering # type: ignore\n",
    "import cdutils.input_cleansing # type: ignore\n",
    "import cdutils.cmo_append # type: ignore\n",
    "import src.add_fields\n",
    "import src.core_transform\n",
    "import src.output_to_excel\n",
    "from src._version import __version__\n",
    "import src.output_to_excel_multiple_sheets\n",
    "\n",
    "# def main(production_flag: bool=False):\n",
    "#     if production_flag:\n",
    "#         BASE_PATH = Path(r'\\\\00-DA1\\Home\\Share\\Line of Business_Shared Services')\n",
    "#         assert \"prod\" in __version__, (f\"Cannot run in production mode without 'prod' in the __version__\")\n",
    "#     else:\n",
    "#         BASE_PATH = Path('.')\n",
    "\n",
    "   \n",
    "    # # Output to excel (raw data)\n",
    "    # OUTPUT_PATH = BASE_PATH / Path('./output/concentration_deposits.xlsx')\n",
    "    # data.to_excel(OUTPUT_PATH, sheet_name='Unformatted', index=False)\n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e973e85b",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Get staging data from the daily deposit update. View dev section of documentation for more detail\n",
    "INPUT_PATH = Path(r\"\\\\00-da1\\Home\\Share\\Data & Analytics Initiatives\\Project Management\\Data_Analytics\\Daily_Deposit_Update\\Production\\output\\DailyDeposit_staging.xlsx\")\n",
    "data = pd.read_excel(INPUT_PATH)\n",
    "\n",
    "# Add portfolio key\n",
    "data = cdutils.pkey_sqlite.add_pkey(data)\n",
    "\n",
    "# Add int rate\n",
    "data = src.add_fields.add_noteintrate(data)\n",
    "\n",
    "\n",
    "# Custom list of minors (Business Deposits)\n",
    "minors = [\n",
    "    'CK24', # 1st Business Checking\n",
    "    'CK12', # Business Checking\n",
    "    'CK25', # Simple Business Checking\n",
    "    'CK30', # Business Elite Money Market\n",
    "    'CK19', # Business Money Market\n",
    "    'CK22', # Business Premium Plus MoneyMkt\n",
    "    'CK23', # Premium Business Checking\n",
    "    'CK40', # Community Assoc Reserve\n",
    "    'CD67', # Commercial Negotiated Rate\n",
    "    'CD01', # 1 Month Business CD\n",
    "    'CD07', # 3 Month Business CD\n",
    "    'CD17', # 6 Month Business CD\n",
    "    'CD31', # 1 Year Business CD\n",
    "    'CD35', # 1 Year Business CD\n",
    "    'CD37', # 18 Month Business CD\n",
    "    'CD38', # 2 Year Business CD\n",
    "    'CD50', # 3 Year Business CD\n",
    "    'CD53', # 4 Year Business CD\n",
    "    'CD59', # 5 Year Business CD\n",
    "    'CD76', # 9 Month Business CD\n",
    "    'CD84', # 15 Month Business CD\n",
    "    'CD95', # Business <12 Month Simple CD\n",
    "    'CD96', # Business >12 Month Simple CD\n",
    "    'CK28', # Investment Business Checking\n",
    "    'CK33', # Specialty Business Checking\n",
    "    'CK34', # ICS Shadow - Business - Demand\n",
    "    'SV06' # Business Select High Yield\n",
    "]\n",
    "\n",
    "# Filter to only business deposit accounts\n",
    "data = cdutils.filtering.filter_to_business_deposits(data, minors)\n",
    "\n",
    "\n",
    "# Add CMO\n",
    "data = cdutils.cmo_append.append_cmo(data)\n",
    "\n",
    "\n",
    "data_schema = {\n",
    "    'noteintrate': float\n",
    "}\n",
    "\n",
    "data = cdutils.input_cleansing.enforce_schema(data, data_schema).copy()\n",
    "\n",
    "# Core transformation pipeline\n",
    "formatted_data = src.core_transform.main_pipeline(data)\n",
    " "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f7f7fc0a",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Output to excel (raw data)\n",
    "OUTPUT_PATH = BASE_PATH / Path('./output/business_deposits_concentration.xlsx')\n",
    "with pd.ExcelWriter(OUTPUT_PATH, engine=\"openpyxl\") as writer:\n",
    "    data.to_excel(writer, sheet_name='Unformatted', index=False)\n",
    "    formatted_data.to_excel(writer, sheet_name='Sheet1', index=False)\n",
    "\n",
    "# Format excel\n",
    "src.output_to_excel_multiple_sheets.format_excel_file(OUTPUT_PATH)\n",
    "\n",
    "# if __name__ == '__main__':\n",
    "#     print(f\"Starting [{__version__}]\")\n",
    "#     # main(production_flag=True)\n",
    "#     main()\n",
    "#     print(\"Complete!\")\n",
    "\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": ".venv",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.9"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
```

## src/add_fields.py

```python
import pandas as pd
from sqlalchemy import text

import cdutils.database.connect # type: ignore

# Function to add interest rate
def add_noteintrate(df):
    """
    Add interest rate
    """
    def retrieve_data():
        """
        Execute a SQL query against the COCC database. You can define whatever tables you want as separate dataframes

        Args:
            n/a

        Returns:
            data (dict): Dictionary (Key/Value pair) with all of the table names you set as keys and the values are the raw data tables from the SQL database
        """
        acctcommon = text("""
        SELECT 
            a.ACCTNBR,
            a.NOTEINTRATE
        FROM 
            OSIBANK.WH_ACCTCOMMON a
        """)

        queries = [
            {'key':'acctcommon', 'sql':acctcommon, 'engine':1},
        ]
        data = cdutils.database.connect.retrieve_data(queries)
        return data

    data = retrieve_data()
    acctcommon = data['acctcommon'].copy()
    acctcommon['acctnbr'] = acctcommon['acctnbr'].astype(str)
    acctcommon['noteintrate'] = pd.to_numeric(acctcommon['noteintrate'])
    
    # Asserts
    assert df is not None
    assert pd.api.types.is_string_dtype(df['acctnbr']), "acctnbr is not a string"
    
    df = pd.merge(df, acctcommon, on='acctnbr', how='left')

    return df
```

## src/core_transform.py

```python
"""
Core Transformations
"""
from typing import Dict
from pathlib import Path

import pandas as pd # type: ignore
import numpy as np # type: ignore

def group_and_summarize(df: pd.DataFrame, group_field: pd.DataFrame, sort_field: pd.DataFrame):
    """
    Groups the df by a field and sorts in descending order by the sort field. This is used for things like the Concentration of Credit/Deposit reports

    Args:
        df (pd.DataFrame)
        group_field (str): field in df that you want to group by
        sort_field (str): field in the df that you want to sort in descending order by (based on group total)

    Returns:
        df (pd.DataFrame)

    Tests/Assertions:
    - Postively assert that sort_field is numeric
    - Validate that the group_field has no null values
    - Assert df is not None
    """
    # Asserts
    assert df is not None, "df cannot be none"
    assert pd.api.types.is_numeric_dtype(df[sort_field]), f"Error: sort_field {sort_field} must be numeric"
    assert df[group_field].notnull().all(), f"Critical error: {group_field} contains null values and we are trying to group on it"

    pieces = []

    # Compute the total for each group based on sort_field and sort groups in descending order
    group_summaries = df.groupby(group_field)[sort_field].sum().sort_values(ascending=False)

    # Loop through each group
    for grp in group_summaries.index:
        grp_df = df[df[group_field] == grp]
        pieces.append(grp_df)

        # find the top ownername
        owner_total = grp_df.groupby("ownersortname")["notebal"].sum()
        top_owner = owner_total.idxmax()

        # Build summary row
        summary = {}
        for col in df.columns:
            if col == group_field:
                summary[col] = grp
            elif col == "ownersortname":
                summary[col] = top_owner 
            elif pd.api.types.is_numeric_dtype(df[col]):
                # Sum numeric columns
                summary[col] = grp_df[col].sum()
            else:
                summary[col] = ""
        pieces.append(pd.DataFrame([summary]))

        # Append a blank row
        blank_row = {col: "" for col in df.columns}
        pieces.append(pd.DataFrame([blank_row]))

    # Concatenate all pieces into one DataFrame
    result = pd.concat(pieces, ignore_index=True)
    return result

def main_pipeline(data: pd.DataFrame) -> pd.DataFrame:
    """
    Main data pipeline 
    """
    # # Set column types
    # numeric_cols = ['noteintrate','bookbalance','notebal']
    # for col in numeric_cols:
    #     df[col] = pd.to_numeric(df[col])

    cmo_col = "Cash Management Officer"

    if cmo_col not in data.columns:
        data[cmo_col] = ""
    else:
        data[cmo_col] = data[cmo_col].fillna("")


    data = data[[
        'portfolio_key',
        'acctnbr',
        'ownersortname',
        'product',
        'mjaccttypcd',
        'currmiaccttypcd',
        'acctofficer',
        'notebal',
        'noteintrate',
        'curracctstatcd',
        'contractdate',
        '3Mo_AvgBal',
        'TTM_AvgBal',
        'Year Ago Balance',
        'TTM_DAYS_OVERDRAWN',
        'TTM_NSF_COUNT',
        'YTD_DAYS_OVERDRAWN',
        'YTD_NSF_COUNT',
        'Cash Management Officer'
    ]].copy()

    df = group_and_summarize(data, "portfolio_key", "notebal")

    return df
```

## src/distribution.py

```python
from typing import List
from pathlib import Path

import win32com.client as win32 # type: ignore

# Usage
# # Distribution
# recipients = [
#     # "chad.doorley@bcsbmail.com"
#     "paul.kocak@bcsbmail.com",
#     "linda.clark@bcsbmail.com"
# ]
# bcc_recipients = [
#     "chad.doorley@bcsbmail.com"
# ]
# subject = f"Weekly Loan Report - {datetime.now().strftime('%m/%d/%Y')}" 
# body = "Hi all, \n\nAttached is the Weekly Loan Report with a 45 day lookback. Please let me know if you have any questions."
# attachment_paths = [OUTPUT_PATH]

def email_out(recipients: List, bcc_recipients: List, subject: str, body: str, attachment_paths: Path) -> None:
    try:
        outlook = win32.Dispatch("Outlook.Application")
        message = outlook.CreateItem(0)
        # message.Display()
        message.To = ";".join(recipients)
        message.BCC = ";".join(bcc_recipients)
        message.Subject = subject
        message.Body = body

        for file_path in attachment_paths:
            absolute_path = str(Path(file_path).absolute())
            message.Attachments.Add(absolute_path)
        message.Send()
        outlook.Quit()
        print("Email sent!")
    except Exception as e:
        print(f"Error: {str(e)}")
    finally:
        outlook = None
```

## src/main.py

```python
"""
Main Entry Point
"""
from pathlib import Path

import pandas as pd # type: ignore

import cdutils.pkey_sqlite # type: ignore
import cdutils.filtering # type: ignore
import cdutils.input_cleansing # type: ignore
import cdutils.cmo_append # type: ignore
import src.add_fields
import src.core_transform
import src.output_to_excel
from src._version import __version__
import src.output_to_excel_multiple_sheets

def main(production_flag: bool=False):
    if production_flag:
        BASE_PATH = Path(r'\\00-DA1\Home\Share\Line of Business_Shared Services')
        assert "prod" in __version__, (f"Cannot run in production mode without 'prod' in the __version__")
    else:
        BASE_PATH = Path('.')

    # Get staging data from the daily deposit update. View dev section of documentation for more detail
    INPUT_PATH = Path(r"\\00-da1\Home\Share\Data & Analytics Initiatives\Project Management\Data_Analytics\Daily_Deposit_Update\Production\output\DailyDeposit_staging.xlsx")
    data = pd.read_excel(INPUT_PATH)

    # Add portfolio key
    data = cdutils.pkey_sqlite.add_pkey(data)

    # Add int rate
    data = src.add_fields.add_noteintrate(data)


    # Custom list of minors (Business Deposits)
    minors = [
        'CK24', # 1st Business Checking
        'CK12', # Business Checking
        'CK25', # Simple Business Checking
        'CK30', # Business Elite Money Market
        'CK19', # Business Money Market
        'CK22', # Business Premium Plus MoneyMkt
        'CK23', # Premium Business Checking
        'CK40', # Community Assoc Reserve
        'CD67', # Commercial Negotiated Rate
        'CD01', # 1 Month Business CD
        'CD07', # 3 Month Business CD
        'CD17', # 6 Month Business CD
        'CD31', # 1 Year Business CD
        'CD35', # 1 Year Business CD
        'CD37', # 18 Month Business CD
        'CD38', # 2 Year Business CD
        'CD50', # 3 Year Business CD
        'CD53', # 4 Year Business CD
        'CD59', # 5 Year Business CD
        'CD76', # 9 Month Business CD
        'CD84', # 15 Month Business CD
        'CD95', # Business <12 Month Simple CD
        'CD96', # Business >12 Month Simple CD
        'CK28', # Investment Business Checking
        'CK33', # Specialty Business Checking
        'CK34', # ICS Shadow - Business - Demand
        'SV06' # Business Select High Yield
    ]

    # Filter to only business deposit accounts
    data = cdutils.filtering.filter_to_business_deposits(data, minors)


    # Add CMO
    data = cdutils.cmo_append.append_cmo(data)


    data_schema = {
        'noteintrate': float
    }

    data = cdutils.input_cleansing.enforce_schema(data, data_schema).copy()

    # Core transformation pipeline
    formatted_data = src.core_transform.main_pipeline(data)
    
    # # Output to excel (raw data)
    # OUTPUT_PATH = BASE_PATH / Path('./output/concentration_deposits.xlsx')
    # data.to_excel(OUTPUT_PATH, sheet_name='Unformatted', index=False)


    # Output to excel (raw data)
    OUTPUT_PATH = BASE_PATH / Path('./output/business_deposits_concentration.xlsx')
    with pd.ExcelWriter(OUTPUT_PATH, engine="openpyxl") as writer:
        data.to_excel(writer, sheet_name='Unformatted', index=False)
        formatted_data.to_excel(writer, sheet_name='Sheet1', index=False)

    # Format excel
    src.output_to_excel_multiple_sheets.format_excel_file(OUTPUT_PATH)

if __name__ == '__main__':
    print(f"Starting [{__version__}]")
    # main(production_flag=True)
    main()
    print("Complete!")
```

## src/output_to_excel.py

```python
"""
Output to Excel
"""

import win32com.client as win32 # type: ignore


def format_excel_file(file_path):
    excel = None
    workbook = None

    # Formatting
    try:
        excel = win32.Dispatch("Excel.Application")
        excel.Visible = False
        workbook = excel.Workbooks.Open(str(file_path.absolute()))
        
        sheet = workbook.Worksheets("Sheet1")

        sheet.Columns.AutoFit()

        # Bold top row
        top_row = sheet.Rows(1)
        top_row.Font.Bold = True

        # Add bottom border to header row
        bottom_border = top_row.Borders(9)
        bottom_border.LineStyle = 1
        bottom_border.Weight = 2

        def format_columns():
            sheet.Columns("K:K").NumberFormat = "mm/dd/yyyy"

            sheet.Columns("I:I").NumberFormat = "0.00%"
            
            sheet.Columns("H:H").NumberFormat = "$#,##0.00"
            sheet.Columns("L:L").NumberFormat = "$#,##0.00"
            sheet.Columns("M:M").NumberFormat = "$#,##0.00"
            sheet.Columns("N:N").NumberFormat = "$#,##0.00"
            sheet.Columns("O:O").NumberFormat = "$#,##0.00"

        format_columns()

        # Freeze top row
        sheet.Application.ActiveWindow.SplitRow = 1
        sheet.Application.ActiveWindow.FreezePanes = True

        excel.DisplayAlerts = False
        workbook.Save()

        # print(f"Excel file saved with autofit at {file_path}")
    except Exception as e:
        print(f"Error: {str(e)}")
    finally:
        if workbook is not None:
            workbook.Close(SaveChanges=False)
        if excel is not None:
            excel.Quit()
```

## src/output_to_excel_multiple_sheets.py

```python
"""
Output to Excel
"""

import win32com.client as win32 # type: ignore


def format_excel_file(file_path):
    excel = None
    workbook = None
    # Formatting
    try:
        excel = win32.Dispatch("Excel.Application")
        excel.Visible = False
        workbook = excel.Workbooks.Open(str(file_path.absolute()))

        summary_sheet = ['Sheet1']

        for sheet in workbook.Sheets:

            sheet.Columns.AutoFit()

            # Bold top row
            top_row = sheet.Rows(1)
            top_row.Font.Bold = True

            # Add bottom border to header row
            bottom_border = top_row.Borders(9)
            bottom_border.LineStyle = 1
            bottom_border.Weight = 2

            # Freeze top row
            sheet.Application.ActiveWindow.SplitRow = 1
            sheet.Application.ActiveWindow.FreezePanes = True
            
            if sheet.Name not in summary_sheet:
                def format_columns():
                    sheet.Columns("K:K").NumberFormat = "mm/dd/yyyy"

                    sheet.Columns("I:I").NumberFormat = "0.00%"
                    
                    sheet.Columns("H:H").NumberFormat = "$#,##0.00"
                    sheet.Columns("L:L").NumberFormat = "$#,##0.00"
                    sheet.Columns("M:M").NumberFormat = "$#,##0.00"
                    sheet.Columns("N:N").NumberFormat = "$#,##0.00"
                    sheet.Columns("O:O").NumberFormat = "$#,##0.00"


                format_columns()
            
            if sheet.Name in summary_sheet:
                def format_columns():
                    sheet.Columns("K:K").NumberFormat = "mm/dd/yyyy"

                    sheet.Columns("I:I").NumberFormat = "0.00%"
                    
                    sheet.Columns("H:H").NumberFormat = "$#,##0.00"
                    sheet.Columns("L:L").NumberFormat = "$#,##0.00"
                    sheet.Columns("M:M").NumberFormat = "$#,##0.00"
                    sheet.Columns("N:N").NumberFormat = "$#,##0.00"
                    sheet.Columns("O:O").NumberFormat = "$#,##0.00"


                format_columns()

        workbook.Save()

        # print(f"Excel file saved with autofit at {file_path}")
    except Exception as e:
        print(f"Error: {str(e)}")
    finally:
        if workbook is not None:
            workbook.Close(SaveChanges=False)
        if excel is not None:
            excel.Quit()
```

## src/transformations/calculations.py

```python
import numpy as np
import pandas as pd

def append_total_exposure_field(df):
    """ 
    Single Obligor Exposure Calculation
    
    Args:
        df: loan_data is loaded in
    
    Returns:
        df: loan_data is returned with new fields appended
        
    Operations:
        bookbalance -> if currmiaccttypcd == 'CM45', use notebal, else bookbalance
            - Tax Exempt bonds always have $0 as book balance so adjustment is made
        net balance == bookbalance - cobal
            - BCSB balance - Charged off amount (COBAL)
        net available == available balance amount * (1 - total pct sold)
        net collateral reserve == collateral reserve * (1 - total pct sold)
        total exposure == net balance + net available + net collateral reserve
    """
    # QA test
    list_of_numeric = ['bookbalance','notebal','availbalamt','totalpctsold','noteopenamt','creditlimitamt','noteintrate','cobal','credlimitclatresamt']
    for col in list_of_numeric:
        df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)

    def convert_to_float(value):
        try:
            return float(value)
        except:
            return None
        
    for col in list_of_numeric:
        df[col] = df[col].apply(convert_to_float)
    
    # Tax Exempt bonds always have $0 Book Balance so need to take NOTEBAL
    df['bookbalance'] = np.where(df['currmiaccttypcd'].isin(['CM45']), df['notebal'], df['bookbalance'])
    df['Net Balance'] = df['bookbalance'] - df['cobal']
    df['Net Available'] = df['availbalamt'] * (1 - df['totalpctsold'])
    df['Net Collateral Reserve'] = df['credlimitclatresamt'] * (1 - df['totalpctsold'])
    df['Total Exposure'] = df['Net Balance'] + df['Net Available'] + df['Net Collateral Reserve']
    return df

def cleaning_loan_data(main_loan_data):
    """
    Additional cleaning of the main_loan_data dataset, excluding ACH manager products and converting datetime fields to appropriate data type
    
    Args:
        main_loan_data (pd.DataFrame)

    Returns:
        main_loan_data (pd.DataFrame)
    """
    # Exclude ACH Manager products
    main_loan_data = main_loan_data.loc[main_loan_data['currmiaccttypcd'] != 'CI07'].copy()

    # Convert datetime fields
    date_fields = ['origdate','datemat']
    main_loan_data[date_fields] = main_loan_data[date_fields].apply(pd.to_datetime)

    # Create calculated field for total original loan amount
    main_loan_data['orig_ttl_loan_amt'] = np.where(main_loan_data['noteopenamt'] == 0, main_loan_data['creditlimitamt'], main_loan_data['noteopenamt'])

    return main_loan_data
```

## src/transformations/joining.py

```python
import pandas as pd # type: ignore

def join_loan_tables(wh_acctcommon_me, wh_acctloan_me, wh_loans_me, wh_acct_me):
    """
    Merging core loan tables on acctnbr

    Args:
        wh_acctcommon_me (pd.DataFrame): (month end) from COCCDM
        wh_acctloan_me (pd.DataFrame): (month end) from COCCDM
        wh_acctcommon_me (pd.DataFrame): (month end) from COCCDM
        wh_acctcommon_me (pd.DataFrame): (month end) from COCCDM
    
    Returns:
        df (pd.DataFrame): Combined loan tables into a df
    """
    # Pre-merge validation
    assert wh_acctcommon_me['acctnbr'].is_unique, "Duplicates exist"
    assert wh_acctloan_me['acctnbr'].is_unique, "Duplicates exist"
    assert wh_loans_me['acctnbr'].is_unique, "Duplicates exist"
    assert wh_acct_me['acctnbr'].is_unique, "Duplicates exist"

    # Merging
    df = pd.merge(wh_acctcommon_me, wh_acctloan_me, on='acctnbr', how='left')
    df = pd.merge(df, wh_loans_me, on='acctnbr', how='left')
    df = pd.merge(df, wh_acct_me, on='acctnbr', how='left')

    # df = df[~(df['fdiccatcd'].isnull())].copy()

    return df

def join_prop_tables(wh_prop, wh_prop2):
    """
    Joining property tables together in a left-join on wh_prop.

    Args:
        wh_prop (pd.DataFrame): OSIBANK.WH_PROP
        wh_prop2 (pd.DataFrame): OSIBANK.WH_PROP2
    
    Returns:
        df (pd.DataFrame): Joined property tables as a df
    """
    wh_prop2 = wh_prop2.drop_duplicates(subset='propnbr', keep='first')

    # Tests
    assert wh_prop2['propnbr'].is_unique, "Duplicates exist"

    wh_prop2 = wh_prop2.drop(columns=['acctnbr']).copy()

    # Merge
    df = pd.merge(wh_prop, wh_prop2, on='propnbr', how='left')

    return df

def consolidation_with_one_prop(main_loan_data, property_data):
    """
    This is the main_loan_data joined with property_data, filtered to only one property per acctnbr.
    This is filtered on max(appraisal value)

    Args:
        main_loan_data (pd.DataFrame)
        property_data (pd.DataFrame)

    Returns:
        df (pd.DataFrame): df with one property per acctnbr
    """
    # Deduplicate the property data based on max appraisal_value_amt
    property_data_sorted = property_data.sort_values(by=['acctnbr','aprsvalueamt'], ascending=[True, False])
    property_dedup = property_data_sorted.drop_duplicates(subset='acctnbr', keep='first')

    # Pre-merge validation
    assert main_loan_data['acctnbr'].is_unique, "Duplicates exist"
    assert property_dedup['acctnbr'].is_unique, "Duplicates exist"

    # Merge
    df = pd.merge(main_loan_data, property_dedup, on='acctnbr', how='left')
    return df

def consolidation_with_multiple_props(main_loan_data, property_data):
    """
    This is the main_loan_data joined with property_data, including multiple properties per acctnbr.
    Keep in mind acctnbr field is not unique here.

    Args:
        main_loan_data (pd.DataFrame)
        property_data (pd.DataFrame)

    Returns:
        df (pd.DataFrame): df with multiple properties per acctnbr
    """
    # Pre-merge validation
    assert main_loan_data['acctnbr'].is_unique, "Duplicates exist"

    # Merge
    df = pd.merge(main_loan_data, property_data, on='acctnbr', how='left')
    return df
```

## src/transformations/__init__.py

```python

```

## src/_version.py

```python
# Report Name
__version__ = "v1.2.0-dev"
```

## src/__init__.py

```python

```

## Statistics

- Total Files: 13
- Total Characters: 139517
- Total Tokens: 0
